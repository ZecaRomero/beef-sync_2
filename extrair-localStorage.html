<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrair Dados do localStorage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        .warning {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        .success {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .data-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .data-section h3 {
            margin-top: 0;
            color: #555;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Extrair Dados do localStorage</h1>
        
        <div class="info">
            <strong>‚ÑπÔ∏è Instru√ß√µes:</strong>
            <ol>
                <li>Abra esta p√°gina no mesmo navegador onde voc√™ usa o Beef Sync</li>
                <li>Clique em "Extrair Dados do localStorage"</li>
                <li>Os dados ser√£o salvos em um arquivo JSON</li>
                <li>Execute o script de sincroniza√ß√£o para enviar ao PostgreSQL</li>
            </ol>
        </div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <h4>Animais</h4>
                <div class="number" id="animalsCount">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h4>Mortes</h4>
                <div class="number" id="deathsCount">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h4>DNA</h4>
                <div class="number" id="dnaCount">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <h4>Outros</h4>
                <div class="number" id="othersCount">0</div>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="extractData()" id="extractBtn">
                üì¶ Extrair Dados do localStorage
            </button>
            <button onclick="clearLocalStorage()" style="background: #f44336;">
                üóëÔ∏è Limpar localStorage (Cuidado!)
            </button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        function extractData() {
            const btn = document.getElementById('extractBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Extraindo...';

            try {
                // Extrair todos os dados do localStorage
                const data = {
                    timestamp: new Date().toISOString(),
                    animals: [],
                    deaths: [],
                    dna: [],
                    nitrogenio: [],
                    exames: [],
                    notasFiscais: [],
                    custos: [],
                    outros: {}
                };

                // Animais
                const animalsStr = localStorage.getItem('animals');
                if (animalsStr) {
                    try {
                        data.animals = JSON.parse(animalsStr);
                    } catch (e) {
                        console.error('Erro ao parsear animals:', e);
                    }
                }

                // Mortes
                const deathsStr = localStorage.getItem('deaths') || localStorage.getItem('mortes');
                if (deathsStr) {
                    try {
                        data.deaths = JSON.parse(deathsStr);
                    } catch (e) {
                        console.error('Erro ao parsear deaths:', e);
                    }
                }

                // DNA
                const dnaStr = localStorage.getItem('dna') || localStorage.getItem('dna_animais');
                if (dnaStr) {
                    try {
                        data.dna = JSON.parse(dnaStr);
                    } catch (e) {
                        console.error('Erro ao parsear dna:', e);
                    }
                }

                // Nitrog√™nio
                const nitrogenioStr = localStorage.getItem('nitrogenio') || localStorage.getItem('abastecimento_nitrogenio');
                if (nitrogenioStr) {
                    try {
                        data.nitrogenio = JSON.parse(nitrogenioStr);
                    } catch (e) {
                        console.error('Erro ao parsear nitrogenio:', e);
                    }
                }

                // Exames androl√≥gicos
                const examesStr = localStorage.getItem('exames') || localStorage.getItem('exames_andrologicos');
                if (examesStr) {
                    try {
                        data.exames = JSON.parse(examesStr);
                    } catch (e) {
                        console.error('Erro ao parsear exames:', e);
                    }
                }

                // Notas fiscais
                const nfStr = localStorage.getItem('notasFiscais') || localStorage.getItem('notas_fiscais');
                if (nfStr) {
                    try {
                        data.notasFiscais = JSON.parse(nfStr);
                    } catch (e) {
                        console.error('Erro ao parsear notas fiscais:', e);
                    }
                }

                // Custos
                const custosStr = localStorage.getItem('custos');
                if (custosStr) {
                    try {
                        data.custos = JSON.parse(custosStr);
                    } catch (e) {
                        console.error('Erro ao parsear custos:', e);
                    }
                }

                // Outros dados (tudo que n√£o foi capturado acima)
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!['animals', 'deaths', 'mortes', 'dna', 'dna_animais', 'nitrogenio', 
                          'abastecimento_nitrogenio', 'exames', 'exames_andrologicos', 
                          'notasFiscais', 'notas_fiscais', 'custos'].includes(key)) {
                        try {
                            const value = localStorage.getItem(key);
                            data.outros[key] = JSON.parse(value);
                        } catch (e) {
                            data.outros[key] = localStorage.getItem(key);
                        }
                    }
                }

                // Atualizar estat√≠sticas
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('animalsCount').textContent = data.animals.length;
                document.getElementById('deathsCount').textContent = data.deaths.length;
                document.getElementById('dnaCount').textContent = data.dna.length;
                document.getElementById('othersCount').textContent = Object.keys(data.outros).length;

                // Criar arquivo para download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `localStorage-backup-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Mostrar resultado
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Dados Extra√≠dos com Sucesso!</h3>
                        <p><strong>Total de registros encontrados:</strong></p>
                        <ul>
                            <li>üêÑ Animais: ${data.animals.length}</li>
                            <li>üíÄ Mortes: ${data.deaths.length}</li>
                            <li>üß¨ DNA: ${data.dna.length}</li>
                            <li>‚ùÑÔ∏è Nitrog√™nio: ${data.nitrogenio.length}</li>
                            <li>üî¨ Exames: ${data.exames.length}</li>
                            <li>üìÑ Notas Fiscais: ${data.notasFiscais.length}</li>
                            <li>üí∞ Custos: ${data.custos.length}</li>
                            <li>üì¶ Outros: ${Object.keys(data.outros).length} itens</li>
                        </ul>
                        <p><strong>Arquivo salvo:</strong> localStorage-backup-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json</p>
                        <p><strong>Pr√≥ximo passo:</strong> Execute o comando abaixo para sincronizar com o PostgreSQL:</p>
                        <pre>node sincronizar-localStorage.js localStorage-backup-XXXX.json</pre>
                    </div>
                `;

                btn.textContent = '‚úÖ Dados Extra√≠dos!';
                btn.style.background = '#28a745';

            } catch (error) {
                console.error('Erro ao extrair dados:', error);
                document.getElementById('result').innerHTML = `
                    <div class="warning">
                        <h3>‚ùå Erro ao Extrair Dados</h3>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                btn.disabled = false;
                btn.textContent = 'üì¶ Extrair Dados do localStorage';
            }
        }

        function clearLocalStorage() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso vai apagar TODOS os dados do localStorage!\n\nTem certeza que deseja continuar?\n\nRecomendamos fazer backup antes (bot√£o "Extrair Dados").')) {
                if (confirm('üö® √öLTIMA CONFIRMA√á√ÉO: Todos os dados ser√£o perdidos!\n\nContinuar?')) {
                    localStorage.clear();
                    alert('‚úÖ localStorage limpo com sucesso!');
                    location.reload();
                }
            }
        }

        // Verificar dados ao carregar
        window.onload = function() {
            const animalsStr = localStorage.getItem('animals');
            if (animalsStr) {
                try {
                    const animals = JSON.parse(animalsStr);
                    if (animals.length > 0) {
                        document.getElementById('result').innerHTML = `
                            <div class="info">
                                <h3>üìä Dados Encontrados no localStorage</h3>
                                <p>Foram encontrados <strong>${animals.length} animais</strong> no localStorage.</p>
                                <p>Clique em "Extrair Dados" para fazer backup e sincronizar com o PostgreSQL.</p>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.error('Erro ao verificar animals:', e);
                }
            }
        };
    </script>
</body>
</html>
