
import React, { useEffect, useState } from 'react'
import { useRouter } from 'next/router'

// Hooks customizados
import useContabilidade from '../../hooks/useContabilidade'
import useRecipients from '../../hooks/useRecipients'

// Utilit√°rios
import { 
  downloadBoletimGado, 
  enviarPorEmail, 
  enviarPorWhatsApp, 
  downloadNotasFiscais, 
  sendAllReports 
} from '../../utils/reportUtils'

// Componentes UI
import { 
  DocumentTextIcon,
  DocumentArrowDownIcon,
  PaperAirplaneIcon,
  ChartBarIcon,
  TableCellsIcon,
  CalendarIcon,
  UserGroupIcon,
  TruckIcon,
  PlusIcon,
  TrashIcon,
  EnvelopeIcon,
  ChatBubbleLeftRightIcon,
  PencilIcon
} from '../../components/ui/Icons'
import Button from '../../components/ui/Button'
import { Card, CardHeader, CardBody } from '../../components/ui/Card'
import { Modal } from '../../components/ui/Modal'
import Input from '../../components/ui/Input'
import ModernLayout from '../../components/ui/ModernLayout'
import StatsCard from '../../components/ui/StatsCard'
import ModernCard, { ModernCardHeader, ModernCardBody } from '../../components/ui/ModernCard'
import LoadingSpinner from '../../components/ui/LoadingSpinner'

// Componentes espec√≠ficos da contabilidade
import ReportCard from '../../components/contabilidade/ReportCard'
import RecipientsList from '../../components/contabilidade/RecipientsList'
export default function Contabilidade() {
  const router = useRouter()
  
  // Hooks customizados
  const {
    loading,
    error,
    reportStats,
    resumoAnimais,
    animaisData,
    nfsEntradasData,
    nfsSaidasData,
    loadStats,
    loadResumoAnimais,
    setLoading
  } = useContabilidade()

  const {
    recipients,
    selectedRecipients,
    showAddRecipient,
    newRecipient,
    setNewRecipient,
    setShowAddRecipient,
    addRecipient,
    removeRecipient,
    handleRecipientToggle,
    resetForm
  } = useRecipients()

  // Estados locais
  const [period, setPeriod] = useState(() => {
    const now = new Date()
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1)
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0)
    
    return {
      startDate: firstDay.toISOString().split('T')[0],
      endDate: lastDay.toISOString().split('T')[0]
    }
  })
  
  const [graficosSelecionados, setGraficosSelecionados] = useState({
    porRaca: false,
    porIdade: false,
    porSexo: false,
    porSituacao: false
  })
  
  const [recipientData, setRecipientData] = useState({
    email: '',
    whatsapp: '',
    role: 'Contador'
  })
  const [showNFDetails, setShowNFDetails] = useState(false)
  const [selectedNF, setSelectedNF] = useState(null)
  const [reportStats, setReportStats] = useState({
    totalAnimals: 0,
    nfsEntradas: 0,
    nfsSaidas: 0,
    movimentacoes: 0
  })
  const [showCardDetails, setShowCardDetails] = useState(null)
  const [resumoAnimais, setResumoAnimais] = useState({
    totalAnimais: 0,
    porSexo: { Macho: 0, F√™mea: 0 },
    porRaca: {}
  })
  const [showGraficos, setShowGraficos] = useState(false)
  const [graficosData, setGraficosData] = useState(null)
  const [nfsEntradasData, setNfsEntradasData] = useState([])
  const [nfsSaidasData, setNfsSaidasData] = useState([])
  const [animaisData, setAnimaisData] = useState([])
  const [editingAnimal, setEditingAnimal] = useState(null)

  // Carregar dados na inicializa√ß√£o
  useEffect(() => {
    const loadData = async () => {
      await loadStats()
      loadResumoAnimais()
    }
    
    loadData()
  }, [loadStats, loadResumoAnimais])

  // Atualizar resumo quando a p√°gina receber foco
  useEffect(() => {
    const handleFocus = async () => {
      await loadStats()
      loadResumoAnimais()
    }

    window.addEventListener('focus', handleFocus)
    return () => window.removeEventListener('focus', handleFocus)
  }, [loadStats, loadResumoAnimais])

  // Fechar modal de detalhes dos cards quando abrir modal de NF
  useEffect(() => {
    if (showNFDetails && showCardDetails) {
      console.log('üîç Fechando modal de detalhes dos cards para abrir modal de NF')
      setShowCardDetails(null)
    }
  }, [showNFDetails])

  // Debug do estado dos modais
  useEffect(() => {
    console.log('üîç Estados dos modais - showCardDetails:', showCardDetails, 'showNFDetails:', showNFDetails)
  }, [showCardDetails, showNFDetails])

  // Estados adicionais para modais e gr√°ficos
  const [showCardDetails, setShowCardDetails] = useState(null)
  const [showNFDetails, setShowNFDetails] = useState(false)
  const [selectedNF, setSelectedNF] = useState(null)
  const [showGraficos, setShowGraficos] = useState(false)
  const [graficosData, setGraficosData] = useState(null)
  const [editingAnimal, setEditingAnimal] = useState(null)

  // Fechar modal de detalhes dos cards quando abrir modal de NF
  useEffect(() => {
    if (showNFDetails && showCardDetails) {
      console.log('üîç Fechando modal de detalhes dos cards para abrir modal de NF')
      setShowCardDetails(null)
    }
  }, [showNFDetails, showCardDetails])

  // Debug do estado dos modais
  useEffect(() => {
    console.log('üîç Estados dos modais - showCardDetails:', showCardDetails, 'showNFDetails:', showNFDetails)
  }, [showCardDetails, showNFDetails])

  // Fun√ß√µes de navega√ß√£o e a√ß√µes
  const navegarParaEdicaoNF = (nf) => {
    console.log('üîç Navegando para edi√ß√£o da NF:', nf)
    localStorage.setItem('nfParaEdicao', JSON.stringify(nf))
    router.push('/notas-fiscais')
  }

  // Handlers para relat√≥rios usando os utilit√°rios
  const handleDownloadBoletim = (sendToAccounting = false) => {
    downloadBoletimGado(period, animaisData, sendToAccounting, setLoading)
  }

  const handleEnviarEmail = () => {
    enviarPorEmail(period, animaisData, setLoading)
  }

  const handleEnviarWhatsApp = () => {
    enviarPorWhatsApp(period, animaisData, setLoading)
  }

  const handleDownloadNFs = () => {
    downloadNotasFiscais(period, setLoading)
  }

  const handleSendAllReports = () => {
    sendAllReports(period, selectedRecipients, recipients, setLoading)
  }

  // Fun√ß√£o para gerar gr√°ficos (mantida pois √© espec√≠fica da p√°gina)
  const gerarGraficos = async () => {
    try {
      setLoading(true)
      
      const response = await fetch('/api/contabilidade/graficos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ period, animalsData })
      })

      if (!response.ok) throw new Error('Erro ao gerar gr√°ficos')
      
      const dados = await response.json()
      setGraficosData(dados)
      setShowGraficos(true)
      
      alert('‚úÖ Gr√°ficos gerados com sucesso!')
      
    } catch (error) {
      console.error('Erro ao gerar gr√°ficos:', error)
      alert('‚ùå Erro ao gerar gr√°ficos: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  // Mostrar loading se estiver carregando
  if (loading && !reportStats.totalAnimals) {
    return (
      <ModernLayout
        title="Relat√≥rios para Contabilidade"
        subtitle="Carregando dados..."
        icon="üìä"
      >
        <div className="flex justify-center items-center min-h-[400px]">
          <LoadingSpinner size="lg" text="Carregando dados da contabilidade..." />
        </div>
      </ModernLayout>
    )
  }

  // Mostrar erro se houver
  if (error) {
    return (
      <ModernLayout
        title="Relat√≥rios para Contabilidade"
        subtitle="Erro ao carregar dados"
        icon="üìä"
      >
        <ModernCard variant="glass" className="border-red-200 dark:border-red-800 bg-red-50/80 dark:bg-red-900/20">
          <ModernCardBody>
            <div className="flex items-center space-x-3">
              <div className="p-2 bg-red-500 rounded-xl text-white">
                <span>‚ö†Ô∏è</span>
              </div>
              <div>
                <h3 className="font-semibold text-red-800 dark:text-red-200">
                  Erro no Sistema
                </h3>
                <p className="text-sm text-red-700 dark:text-red-300 mt-1">
                  {error}
                </p>
              </div>
            </div>
          </ModernCardBody>
        </ModernCard>
      </ModernLayout>
    )
    try {
      // Primeiro tentar carregar da API (PostgreSQL)
      try {
        const response = await fetch('/api/animals')
        if (response.ok) {
          const result = await response.json()
          // A API retorna um objeto com propriedade data
          const animals = Array.isArray(result) ? result : (result.data || [])
          
          // Salvar os dados completos dos animais
          setAnimaisData(animals)
          
          const porSexo = animals.reduce((acc, animal) => {
            const sexo = animal.sexo || 'N√£o informado'
            acc[sexo] = (acc[sexo] || 0) + 1
            return acc
          }, {})

          const porRaca = animals.reduce((acc, animal) => {
            const raca = animal.raca || 'N√£o informado'
            acc[raca] = (acc[raca] || 0) + 1
            return acc
          }, {})

          setResumoAnimais({
            totalAnimais: animals.length,
            porSexo,
            porRaca
          })
          
          console.log('‚úÖ Resumo carregado da API:', animals.length, 'animais')
          return
        }
      } catch (apiError) {
        console.error('‚ùå Erro ao conectar com API:', apiError)
      }
      
      // Fallback para localStorage
      const animals = JSON.parse(localStorage.getItem('animals') || '[]')
      
      // Salvar os dados completos dos animais
      setAnimaisData(animals)
      
      const porSexo = animals.reduce((acc, animal) => {
        const sexo = animal.sexo || 'N√£o informado'
        acc[sexo] = (acc[sexo] || 0) + 1
        return acc
      }, {})

      const porRaca = animals.reduce((acc, animal) => {
        const raca = animal.raca || 'N√£o informado'
        acc[raca] = (acc[raca] || 0) + 1
        return acc
      }, {})

      setResumoAnimais({
        totalAnimais: animals.length,
        porSexo,
        porRaca
      })
      
      console.log('‚ö†Ô∏è Resumo carregado do localStorage:', animals.length, 'animais')
    } catch (error) {
      console.error('Erro ao carregar resumo dos animais:', error)
    }
  }

  const loadRecipients = () => {
    const saved = localStorage.getItem('contabilidadeRecipients')
    if (saved) {
      setRecipients(JSON.parse(saved))
    }
  }

  const saveRecipients = (newRecipients) => {
    localStorage.setItem('contabilidadeRecipients', JSON.stringify(newRecipients))
    setRecipients(newRecipients)
  }

  const navegarParaEdicaoNF = (nf) => {
    console.log('üîç Navegando para edi√ß√£o da NF:', nf)
    // Salvar a NF selecionada no localStorage para a p√°gina de notas fiscais
    localStorage.setItem('nfParaEdicao', JSON.stringify(nf))
    // Navegar para a p√°gina de notas fiscais
    router.push('/notas-fiscais')
  }

  const loadStats = async () => {
    try {
      // Limpar localStorage para evitar inconsist√™ncias
      localStorage.removeItem('nfsEntradas')
      localStorage.removeItem('nfsSaidas')
      localStorage.removeItem('notasFiscais')
      
      // Carregar animais da API
      let totalAnimals = 0
      try {
        const animalsResponse = await fetch('/api/animals')
        if (animalsResponse.ok) {
          const result = await animalsResponse.json()
          const animals = Array.isArray(result) ? result : (result.data || [])
          totalAnimals = animals.length
        }
      } catch (error) {
        console.error('Erro ao carregar animais da API:', error)
        // Fallback para localStorage
        const animals = JSON.parse(localStorage.getItem('animals') || '[]')
        totalAnimals = animals.length
      }

      // Carregar notas fiscais da API
      let nfsEntradas = 0
      let nfsSaidas = 0
      let nfsEntradasData = []
      let nfsSaidasData = []
      
      try {
        const nfsResponse = await fetch('/api/notas-fiscais?' + Date.now(), {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        })
        if (nfsResponse.ok) {
          const nfs = await nfsResponse.json()
          const nfsArray = Array.isArray(nfs) ? nfs : (Array.isArray(nfs.data) ? nfs.data : [])
          
          nfsEntradasData = nfsArray.filter(nf => nf.tipo === 'entrada')
          nfsSaidasData = nfsArray.filter(nf => nf.tipo === 'saida')
          
          nfsEntradas = nfsEntradasData.length
          nfsSaidas = nfsSaidasData.length
        }
      } catch (error) {
        console.error('Erro ao carregar NFs da API:', error)
        // Sem fallback - manter consist√™ncia com p√°gina de notas fiscais
        nfsEntradas = 0
        nfsSaidas = 0
        nfsEntradasData = []
        nfsSaidasData = []
      }
      
      setReportStats({
        totalAnimals,
        nfsEntradas,
        nfsSaidas,
        movimentacoes: nfsEntradas + nfsSaidas
      })
      
      setNfsEntradasData(nfsEntradasData)
      setNfsSaidasData(nfsSaidasData)
    } catch (error) {
      console.error('Erro ao carregar estat√≠sticas:', error)
    }
  }

  const loadAnimaisDetalhados = async () => {
    try {
      // Tentar carregar da API primeiro
      const response = await fetch('/api/animals')
      if (response.ok) {
        const result = await response.json()
        const animals = Array.isArray(result) ? result : (result.data || [])
        setAnimaisData(animals)
        return
      }
    } catch (error) {
      console.error('Erro ao carregar animais da API:', error)
    }
    
    // Fallback para localStorage
    const animals = JSON.parse(localStorage.getItem('animals') || '[]')
    setAnimaisData(animals)
  }

  const addRecipient = () => {
    if (!newRecipient.name || (!newRecipient.email && !newRecipient.whatsapp)) {
      alert('‚ö†Ô∏è Aten√ß√£o: Nome e Email ou WhatsApp s√£o obrigat√≥rios')
      return
    }

    const recipient = {
      id: Date.now().toString(),
      ...newRecipient
    }

    const updatedRecipients = [...recipients, recipient]
    saveRecipients(updatedRecipients)
    
    setNewRecipient({ name: '', email: '', whatsapp: '', role: 'Contador' })
    setShowAddRecipient(false)
    alert('‚úÖ Sucesso! Destinat√°rio adicionado com sucesso!')
  }

  const removeRecipient = (recipientId) => {
    const updatedRecipients = recipients.filter(r => r.id !== recipientId)
    saveRecipients(updatedRecipients)
    setSelectedRecipients(prev => prev.filter(id => id !== recipientId))
    alert('‚úÖ Sucesso! Destinat√°rio removido com sucesso!')
  }

  const handleRecipientToggle = (recipientId) => {
    setSelectedRecipients(prev => 
      prev.includes(recipientId) 
        ? prev.filter(id => id !== recipientId)
        : [...prev, recipientId]
    )
  }

  const downloadBoletimGado = async (sendToAccounting = false) => {
    try {
      setLoading(true)
      
      // Primeiro tentar carregar da API (PostgreSQL)
      let animalsData = []
      try {
        const response = await fetch('/api/animals')
        if (response.ok) {
          const result = await response.json()
          animalsData = Array.isArray(result) ? result : (result.data || [])
          console.log('‚úÖ Animais carregados da API para boletim:', animalsData.length)
        } else {
          throw new Error('API n√£o dispon√≠vel')
        }
      } catch (apiError) {
        console.error('‚ùå Erro ao conectar com API, usando localStorage:', apiError)
        // Fallback para localStorage
        animalsData = JSON.parse(localStorage.getItem('animals') || '[]')
        console.log('‚ö†Ô∏è Animais carregados do localStorage:', animalsData.length)
      }
      
      console.log('üîç Enviando dados para boletim:', {
        totalAnimais: animalsData.length,
        sendToAccounting,
        animais: animalsData.map(a => ({
          serie: a.serie,
          rg: a.rg,
          raca: a.raca,
          dataNascimento: a.dataNascimento,
          data_nascimento: a.data_nascimento
        }))
      })
      
      const response = await fetch('/api/contabilidade/boletim-gado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          period,
          animalsData,
          sendToAccounting
        })
      })

      if (!response.ok) throw new Error('Erro ao gerar boletim')
      
      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `boletim-gado-contabilidade-${period.startDate}-${period.endDate}.xlsx`
      document.body.appendChild(a)
      a.click()
      window.URL.revokeObjectURL(url)
      document.body.removeChild(a)
      
      if (sendToAccounting) {
        alert('‚úÖ Sucesso! Boletim de Gado gerado e enviado para contabilidade!')
      } else {
        alert('‚úÖ Sucesso! Boletim de Gado baixado com sucesso!')
      }
    } catch (error) {
      console.error('Erro:', error)
      alert('‚ùå Erro: N√£o foi poss√≠vel gerar o boletim de gado')
    } finally {
      setLoading(false)
    }
  }

  const enviarPorEmail = async () => {
    try {
      setLoading(true)
      
      // Primeiro tentar carregar da API (PostgreSQL)
      let animalsData = []
      try {
        const response = await fetch('/api/animals')
        if (response.ok) {
          const result = await response.json()
          animalsData = Array.isArray(result) ? result : (result.data || [])
          console.log('‚úÖ Animais carregados da API para email:', animalsData.length)
        } else {
          throw new Error('API n√£o dispon√≠vel')
        }
      } catch (apiError) {
        console.error('‚ùå Erro ao conectar com API, usando localStorage:', apiError)
        animalsData = JSON.parse(localStorage.getItem('animals') || '[]')
        console.log('‚ö†Ô∏è Animais carregados do localStorage:', animalsData.length)
      }
      
      // Gerar dados do boletim
      const boletimData = {
        period,
        animalsData,
        sendToAccounting: true
      }
      
      // Criar assunto e corpo do email
      const assunto = `Boletim de Gado - ${period.startDate} at√© ${period.endDate}`
      const corpo = `
Ol√°!

Segue em anexo o Boletim de Gado referente ao per√≠odo de ${period.startDate} at√© ${period.endDate}.

üìä RESUMO DO PER√çODO:
‚Ä¢ Total de animais: ${animalsData.length}
‚Ä¢ Per√≠odo: ${period.startDate} at√© ${period.endDate}
‚Ä¢ Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}

O arquivo Excel cont√©m:
‚úÖ Boletim por Ra√ßa
‚úÖ Resumo Executivo  
‚úÖ Detalhes dos Animais

Este relat√≥rio foi gerado automaticamente pelo sistema Beef Sync.

Atenciosamente,
Sistema Beef Sync
      `.trim()
      
      // Criar link mailto com Outlook
      const emailBody = encodeURIComponent(corpo)
      const emailSubject = encodeURIComponent(assunto)
      
      // Tentar abrir Outlook
      const outlookUrl = `mailto:?subject=${emailSubject}&body=${emailBody}`
      window.open(outlookUrl, '_blank')
      
      alert('‚úÖ Outlook aberto! Cole o arquivo Excel como anexo e envie.')
      
    } catch (error) {
      console.error('Erro ao preparar email:', error)
      alert('‚ùå Erro ao preparar email: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const enviarPorWhatsApp = async () => {
    try {
      setLoading(true)
      
      // Primeiro tentar carregar da API (PostgreSQL)
      let animalsData = []
      try {
        const response = await fetch('/api/animals')
        if (response.ok) {
          const result = await response.json()
          animalsData = Array.isArray(result) ? result : (result.data || [])
          console.log('‚úÖ Animais carregados da API para WhatsApp:', animalsData.length)
        } else {
          throw new Error('API n√£o dispon√≠vel')
        }
      } catch (apiError) {
        console.error('‚ùå Erro ao conectar com API, usando localStorage:', apiError)
        animalsData = JSON.parse(localStorage.getItem('animals') || '[]')
        console.log('‚ö†Ô∏è Animais carregados do localStorage:', animalsData.length)
      }
      
      // Criar mensagem para WhatsApp
      const mensagem = `üêÑ *BOLETIM DE GADO - BEEF SYNC*

üìÖ *Per√≠odo:* ${period.startDate} at√© ${period.endDate}
üìä *Total de Animais:* ${animalsData.length}

üìà *Resumo por Sexo:*
${animalsData.reduce((acc, animal) => {
  const sexo = animal.sexo || 'N√£o informado'
  acc[sexo] = (acc[sexo] || 0) + 1
  return acc
}, {})}

üìã *Resumo por Ra√ßa:*
${animalsData.reduce((acc, animal) => {
  const raca = animal.raca || 'N√£o informado'
  acc[raca] = (acc[raca] || 0) + 1
  return acc
}, {})}

üìä *Relat√≥rio Completo:*
O arquivo Excel com detalhes completos est√° sendo gerado...

‚è∞ *Gerado em:* ${new Date().toLocaleString('pt-BR')}

_Sistema Beef Sync - Gest√£o de Rebanho_`
      
      // Codificar mensagem para URL
      const mensagemCodificada = encodeURIComponent(mensagem)
      
      // Abrir WhatsApp Web
      const whatsappUrl = `https://web.whatsapp.com/send?text=${mensagemCodificada}`
      window.open(whatsappUrl, '_blank')
      
      alert('‚úÖ WhatsApp Web aberto! A mensagem foi preparada. Envie para o contato desejado.')
      
    } catch (error) {
      console.error('Erro ao preparar WhatsApp:', error)
      alert('‚ùå Erro ao preparar WhatsApp: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const enviarNFsPorEmail = async () => {
    try {
      setLoading(true)
      
      // Criar assunto e corpo do email para NFs
      const assunto = `Relat√≥rio de Notas Fiscais - ${period.startDate} at√© ${period.endDate}`
      const corpo = `
Ol√°!

Segue em anexo o Relat√≥rio de Notas Fiscais referente ao per√≠odo de ${period.startDate} at√© ${period.endDate}.

üìä RESUMO DO PER√çODO:
‚Ä¢ Per√≠odo: ${period.startDate} at√© ${period.endDate}
‚Ä¢ Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}

O arquivo Excel cont√©m:
‚úÖ Todas as NFs de entrada e sa√≠da
‚úÖ Valores, datas e destinos/origens
‚úÖ Naturezas de opera√ß√£o
‚úÖ Resumo financeiro

Este relat√≥rio foi gerado automaticamente pelo sistema Beef Sync.

Atenciosamente,
Sistema Beef Sync
      `.trim()
      
      // Criar link mailto com Outlook
      const emailBody = encodeURIComponent(corpo)
      const emailSubject = encodeURIComponent(assunto)
      
      // Tentar abrir Outlook
      const outlookUrl = `mailto:?subject=${emailSubject}&body=${emailBody}`
      window.open(outlookUrl, '_blank')
      
      alert('‚úÖ Outlook aberto! Cole o arquivo Excel das NFs como anexo e envie.')
      
    } catch (error) {
      console.error('Erro ao preparar email das NFs:', error)
      alert('‚ùå Erro ao preparar email: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const enviarNFsPorWhatsApp = async () => {
    try {
      setLoading(true)
      
      // Criar mensagem para WhatsApp sobre NFs
      const mensagem = `üìÑ *RELAT√ìRIO DE NOTAS FISCAIS - BEEF SYNC*

üìÖ *Per√≠odo:* ${period.startDate} at√© ${period.endDate}

üìä *Relat√≥rio Completo:*
O arquivo Excel com todas as Notas Fiscais est√° sendo gerado...

üìã *Conte√∫do do Relat√≥rio:*
‚úÖ Todas as NFs de entrada e sa√≠da
‚úÖ Valores, datas e destinos/origens  
‚úÖ Naturezas de opera√ß√£o
‚úÖ Resumo financeiro

‚è∞ *Gerado em:* ${new Date().toLocaleString('pt-BR')}

_Sistema Beef Sync - Gest√£o Cont√°bil_`
      
      // Codificar mensagem para URL
      const mensagemCodificada = encodeURIComponent(mensagem)
      
      // Abrir WhatsApp Web
      const whatsappUrl = `https://web.whatsapp.com/send?text=${mensagemCodificada}`
      window.open(whatsappUrl, '_blank')
      
      alert('‚úÖ WhatsApp Web aberto! A mensagem sobre NFs foi preparada. Envie para o contato desejado.')
      
    } catch (error) {
      console.error('Erro ao preparar WhatsApp das NFs:', error)
      alert('‚ùå Erro ao preparar WhatsApp: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const compartilharSistema = () => {
    try {
      const url = window.location.origin + '/contabilidade'
      const texto = `üêÑ Sistema Beef Sync - Gest√£o de Rebanho\n\nAcesse: ${url}\n\nGerencie seu rebanho com facilidade!`
      
      if (navigator.share) {
        navigator.share({
          title: 'Beef Sync - Sistema de Gest√£o',
          text: texto,
          url: url
        })
      } else {
        navigator.clipboard.writeText(texto).then(() => {
          alert('‚úÖ Link copiado para a √°rea de transfer√™ncia!')
        }).catch(() => {
          alert('‚ùå Erro ao copiar link')
        })
      }
    } catch (error) {
      console.error('Erro ao compartilhar:', error)
      alert('‚ùå Erro ao compartilhar sistema')
    }
  }

  const copiarResumo = async () => {
    try {
      setLoading(true)
      
      // Primeiro tentar carregar da API (PostgreSQL)
      let animalsData = []
      try {
        const response = await fetch('/api/animals')
        if (response.ok) {
          const result = await response.json()
          animalsData = Array.isArray(result) ? result : (result.data || [])
        } else {
          throw new Error('API n√£o dispon√≠vel')
        }
      } catch (apiError) {
        animalsData = JSON.parse(localStorage.getItem('animals') || '[]')
      }
      
      const resumo = `üêÑ RESUMO DO REBANHO - BEEF SYNC

üìÖ Per√≠odo: ${period.startDate} at√© ${period.endDate}
üìä Total de Animais: ${animalsData.length}

üìà Por Sexo:
${animalsData.reduce((acc, animal) => {
  const sexo = animal.sexo || 'N√£o informado'
  acc[sexo] = (acc[sexo] || 0) + 1
  return acc
}, {})}

üìã Por Ra√ßa:
${animalsData.reduce((acc, animal) => {
  const raca = animal.raca || 'N√£o informado'
  acc[raca] = (acc[raca] || 0) + 1
  return acc
}, {})}

‚è∞ Gerado em: ${new Date().toLocaleString('pt-BR')}

Sistema Beef Sync - Gest√£o Profissional de Rebanho`
      
      await navigator.clipboard.writeText(resumo)
      alert('‚úÖ Resumo copiado para a √°rea de transfer√™ncia!')
      
    } catch (error) {
      console.error('Erro ao copiar resumo:', error)
      alert('‚ùå Erro ao copiar resumo')
    } finally {
      setLoading(false)
    }
  }

  const gerarGraficos = async () => {
    try {
      setLoading(true)
      
      // Primeiro tentar carregar da API (PostgreSQL)
      let animalsData = []
      try {
        const response = await fetch('/api/animals')
        if (response.ok) {
          const result = await response.json()
          animalsData = Array.isArray(result) ? result : (result.data || [])
          console.log('‚úÖ Animais carregados da API para gr√°ficos:', animalsData.length)
        } else {
          throw new Error('API n√£o dispon√≠vel')
        }
      } catch (apiError) {
        console.error('‚ùå Erro ao conectar com API, usando localStorage:', apiError)
        animalsData = JSON.parse(localStorage.getItem('animals') || '[]')
        console.log('‚ö†Ô∏è Animais carregados do localStorage:', animalsData.length)
      }
      
      // Gerar gr√°ficos
      const response = await fetch('/api/contabilidade/graficos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ period, animalsData })
      })

      if (!response.ok) throw new Error('Erro ao gerar gr√°ficos')
      
      const dados = await response.json()
      setGraficosData(dados)
      setShowGraficos(true)
      
      alert('‚úÖ Gr√°ficos gerados com sucesso!')
      
    } catch (error) {
      console.error('Erro ao gerar gr√°ficos:', error)
      alert('‚ùå Erro ao gerar gr√°ficos: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const compartilharGrafico = async (tipoGrafico, titulo) => {
    try {
      if (!graficosData) {
        alert('‚ùå Nenhum gr√°fico dispon√≠vel. Gere os gr√°ficos primeiro.')
        return
      }

      const graficoBase64 = graficosData.graficos[tipoGrafico]
      if (!graficoBase64) {
        alert('‚ùå Gr√°fico n√£o encontrado.')
        return
      }

      // Converter base64 para blob
      const byteCharacters = atob(graficoBase64)
      const byteNumbers = new Array(byteCharacters.length)
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i)
      }
      const byteArray = new Uint8Array(byteNumbers)
      const blob = new Blob([byteArray], { type: 'image/png' })

      // Tentar usar Web Share API para envio direto
      if (navigator.share && navigator.canShare) {
        try {
          await navigator.share({
            title: `${titulo} - Beef Sync`,
            text: `Gr√°fico ${titulo} do per√≠odo ${period.startDate} at√© ${period.endDate}`,
            files: [new File([blob], `grafico_${titulo.replace(/[^a-zA-Z0-9]/g, '_')}.png`, { type: 'image/png' })]
          })
          alert('‚úÖ Gr√°fico enviado diretamente por email!')
          return
        } catch (error) {
          console.log('Web Share API falhou, tentando m√©todo alternativo')
        }
      }

      // M√©todo alternativo: criar assunto e corpo do email
      const assunto = `${titulo} - Beef Sync - ${period.startDate} at√© ${period.endDate}`
      const corpo = `
Ol√°!

Segue em anexo o gr√°fico "${titulo}" referente ao per√≠odo de ${period.startDate} at√© ${period.endDate}.

üìä INFORMA√á√ïES DO GR√ÅFICO:
‚Ä¢ T√≠tulo: ${titulo}
‚Ä¢ Per√≠odo: ${period.startDate} at√© ${period.endDate}
‚Ä¢ Total de animais: ${graficosData.resumo.total}
‚Ä¢ Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}

Este gr√°fico foi gerado automaticamente pelo sistema Beef Sync.

Atenciosamente,
Sistema Beef Sync
      `.trim()
      
      // Criar link mailto com Outlook
      const emailBody = encodeURIComponent(corpo)
      const emailSubject = encodeURIComponent(assunto)
      
      // Tentar abrir Outlook
      const outlookUrl = `mailto:?subject=${emailSubject}&body=${emailBody}`
      window.open(outlookUrl, '_blank')
      
      // Baixar o gr√°fico automaticamente
      const link = document.createElement('a')
      link.href = URL.createObjectURL(blob)
      link.download = `grafico_${titulo.replace(/[^a-zA-Z0-9]/g, '_')}.png`
      link.style.display = 'none'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      alert('‚úÖ Outlook aberto!\n‚úÖ Gr√°fico baixado automaticamente!\n\nüìß Agora:\n1. Anexe o gr√°fico baixado no email\n2. Envie para o destinat√°rio')
      
    } catch (error) {
      console.error('Erro ao compartilhar gr√°fico:', error)
      alert('‚ùå Erro ao compartilhar gr√°fico: ' + error.message)
    }
  }

  const compartilharGraficoWhatsApp = async (tipoGrafico, titulo) => {
    try {
      if (!graficosData) {
        alert('‚ùå Nenhum gr√°fico dispon√≠vel. Gere os gr√°ficos primeiro.')
        return
      }

      const graficoBase64 = graficosData.graficos[tipoGrafico]
      if (!graficoBase64) {
        alert('‚ùå Gr√°fico n√£o encontrado.')
        return
      }

      // Criar mensagem para WhatsApp
      const mensagem = `üìä *${titulo} - BEEF SYNC*

üìÖ *Per√≠odo:* ${period.startDate} at√© ${period.endDate}
üêÑ *Total de Animais:* ${graficosData.resumo.total}

‚è∞ *Gerado em:* ${new Date().toLocaleString('pt-BR')}

_Sistema Beef Sync - Gest√£o de Rebanho_`
      
      // Converter base64 para blob
      const byteCharacters = atob(graficoBase64)
      const byteNumbers = new Array(byteCharacters.length)
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i)
      }
      const byteArray = new Uint8Array(byteNumbers)
      const blob = new Blob([byteArray], { type: 'image/png' })
      
      // Tentar usar Web Share API para envio direto
      if (navigator.share && navigator.canShare) {
        try {
          await navigator.share({
            title: `${titulo} - Beef Sync`,
            text: mensagem,
            files: [new File([blob], `grafico_${titulo.replace(/[^a-zA-Z0-9]/g, '_')}.png`, { type: 'image/png' })]
          })
          alert('‚úÖ Gr√°fico enviado diretamente via WhatsApp!')
          return
        } catch (error) {
          console.log('Web Share API falhou, tentando m√©todo alternativo')
        }
      }
      
      // M√©todo alternativo: criar link direto para WhatsApp Web
      const mensagemCodificada = encodeURIComponent(mensagem)
      const whatsappUrl = `https://web.whatsapp.com/send?text=${mensagemCodificada}`
      
      // Abrir WhatsApp Web
      window.open(whatsappUrl, '_blank')
      
      // Criar elemento tempor√°rio para download autom√°tico
      const link = document.createElement('a')
      link.href = URL.createObjectURL(blob)
      link.download = `grafico_${titulo.replace(/[^a-zA-Z0-9]/g, '_')}.png`
      link.style.display = 'none'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      alert('‚úÖ WhatsApp Web aberto!\n‚úÖ Gr√°fico baixado automaticamente!\n\nüì± Agora:\n1. Cole a imagem na conversa do WhatsApp\n2. Cole tamb√©m a mensagem de texto\n3. Envie para o destinat√°rio')
      
    } catch (error) {
      console.error('Erro ao compartilhar gr√°fico no WhatsApp:', error)
      alert('‚ùå Erro ao compartilhar gr√°fico no WhatsApp: ' + error.message)
    }
  }

  const compartilharGraficoWhatsAppFallback = async (tipoGrafico, titulo, mensagem, imageUrl) => {
    try {
      // M√©todo alternativo: criar link direto para WhatsApp com imagem
      const mensagemCodificada = encodeURIComponent(mensagem)
      
      // Criar uma nova janela com WhatsApp Web
      const whatsappWindow = window.open('', '_blank', 'width=800,height=600')
      
      // HTML para WhatsApp Web com imagem
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Compartilhar Gr√°fico - Beef Sync</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              padding: 20px; 
              background: #f0f0f0;
              text-align: center;
            }
            .container {
              max-width: 600px;
              margin: 0 auto;
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .image-container {
              margin: 20px 0;
            }
            img {
              max-width: 100%;
              height: auto;
              border: 2px solid #ddd;
              border-radius: 8px;
            }
            .message {
              background: #e8f5e8;
              padding: 15px;
              border-radius: 8px;
              margin: 20px 0;
              white-space: pre-line;
              text-align: left;
            }
            .instructions {
              background: #fff3cd;
              padding: 15px;
              border-radius: 8px;
              margin: 20px 0;
              border-left: 4px solid #ffc107;
            }
            .button {
              background: #25d366;
              color: white;
              padding: 12px 24px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 16px;
              margin: 10px;
            }
            .button:hover {
              background: #128c7e;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h2>üìä Gr√°fico: ${titulo}</h2>
            
            <div class="image-container">
              <img src="${imageUrl}" alt="${titulo}" />
            </div>
            
            <div class="message">
              ${mensagem}
            </div>
            
            <div class="instructions">
              <h3>üì± Como enviar pelo WhatsApp:</h3>
              <p>1. Clique com o bot√£o direito na imagem acima</p>
              <p>2. Selecione "Copiar imagem"</p>
              <p>3. Abra o WhatsApp Web</p>
              <p>4. Cole a imagem na conversa</p>
              <p>5. Cole tamb√©m a mensagem de texto</p>
            </div>
            
            <button class="button" onclick="window.close()">Fechar</button>
            <button class="button" onclick="copyImage()">üìã Copiar Imagem</button>
          </div>
          
          <script>
            function copyImage() {
              const img = document.querySelector('img');
              img.style.border = '3px solid #25d366';
              setTimeout(() => {
                img.style.border = '2px solid #ddd';
                alert('‚úÖ Imagem destacada! Clique com bot√£o direito e "Copiar imagem"');
              }, 500);
            }
          </script>
        </body>
        </html>
      `
      
      whatsappWindow.document.write(htmlContent)
      whatsappWindow.document.close()
      
      alert('‚úÖ Janela aberta com gr√°fico!\n\nüìã Use as instru√ß√µes na janela para copiar e enviar pelo WhatsApp.')
      
    } catch (error) {
      console.error('Erro no m√©todo alternativo:', error)
      alert('‚ùå Erro ao abrir janela de compartilhamento: ' + error.message)
    }
  }

  const handleGraficoSelecionado = (tipoGrafico) => {
    setGraficosSelecionados(prev => ({
      ...prev,
      [tipoGrafico]: !prev[tipoGrafico]
    }))
  }

  const selecionarTodosGraficos = () => {
    setGraficosSelecionados({
      porRaca: true,
      porIdade: true,
      porSexo: true,
      porSituacao: true
    })
  }

  const desmarcarTodosGraficos = () => {
    setGraficosSelecionados({
      porRaca: false,
      porIdade: false,
      porSexo: false,
      porSituacao: false
    })
  }

  const compartilharGraficosSelecionados = async (metodo) => {
    try {
      if (!graficosData) {
        alert('‚ùå Nenhum gr√°fico dispon√≠vel. Gere os gr√°ficos primeiro.')
        return
      }

      // Verificar se pelo menos um gr√°fico est√° selecionado
      const graficosSelecionadosList = Object.entries(graficosSelecionados)
        .filter(([_, selecionado]) => selecionado)
        .map(([tipo, _]) => tipo)

      if (graficosSelecionadosList.length === 0) {
        alert('‚ùå Selecione pelo menos um gr√°fico para enviar.')
        return
      }

      const nomesGraficos = {
        porRaca: 'Distribui√ß√£o por Ra√ßa',
        porIdade: 'Distribui√ß√£o por Classifica√ß√£o Et√°ria',
        porSexo: 'Distribui√ß√£o por Sexo',
        porSituacao: 'Distribui√ß√£o por Situa√ß√£o'
      }

      if (metodo === 'email') {
        // Preparar gr√°ficos selecionados para download
        const graficosParaDownload = graficosSelecionadosList.map(tipo => ({
          nome: nomesGraficos[tipo],
          base64: graficosData.graficos[tipo]
        }))

        // Tentar usar Web Share API para envio direto de m√∫ltiplos arquivos
        if (navigator.share && navigator.canShare) {
          try {
            const files = graficosParaDownload.map(grafico => {
              const byteCharacters = atob(grafico.base64)
              const byteNumbers = new Array(byteCharacters.length)
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i)
              }
              const byteArray = new Uint8Array(byteNumbers)
              const blob = new Blob([byteArray], { type: 'image/png' })
              return new File([blob], `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`, { type: 'image/png' })
            })

            await navigator.share({
              title: 'Gr√°ficos Selecionados do Rebanho - Beef Sync',
              text: `Gr√°ficos selecionados do rebanho referentes ao per√≠odo de ${period.startDate} at√© ${period.endDate}`,
              files: files
            })
            alert(`‚úÖ ${graficosSelecionadosList.length} gr√°fico(s) enviado(s) diretamente por email!`)
            return
          } catch (error) {
            console.log('Web Share API falhou, tentando m√©todo alternativo')
          }
        }

        // M√©todo alternativo: download autom√°tico + Outlook
        const assunto = `Gr√°ficos Selecionados do Rebanho - ${period.startDate} at√© ${period.endDate}`
        const corpo = `
Ol√°!

Segue em anexo os gr√°ficos selecionados do rebanho referentes ao per√≠odo de ${period.startDate} at√© ${period.endDate}.

üìä GR√ÅFICOS INCLU√çDOS:
${graficosSelecionadosList.map(tipo => `‚Ä¢ ${nomesGraficos[tipo]}`).join('\n')}

üìà RESUMO DO PER√çODO:
‚Ä¢ Per√≠odo: ${period.startDate} at√© ${period.endDate}
‚Ä¢ Total de animais: ${graficosData.resumo.total}
‚Ä¢ Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}

Estes gr√°ficos foram gerados automaticamente pelo sistema Beef Sync.

Atenciosamente,
Sistema Beef Sync
        `.trim()
        
        const emailBody = encodeURIComponent(corpo)
        const emailSubject = encodeURIComponent(assunto)
        const outlookUrl = `mailto:?subject=${emailSubject}&body=${emailBody}`
        window.open(outlookUrl, '_blank')
        
        // Baixar gr√°ficos selecionados automaticamente
        graficosParaDownload.forEach((grafico, index) => {
          setTimeout(() => {
            const byteCharacters = atob(grafico.base64)
            const byteNumbers = new Array(byteCharacters.length)
            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i)
            }
            const byteArray = new Uint8Array(byteNumbers)
            const blob = new Blob([byteArray], { type: 'image/png' })
            
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`
            link.style.display = 'none'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
          }, index * 500) // Delay de 500ms entre cada download
        })
        
        alert(`‚úÖ Outlook aberto!\n‚úÖ ${graficosSelecionadosList.length} gr√°fico(s) baixado(s) automaticamente!\n\nüìß Agora:\n1. Anexe os gr√°ficos baixados no email\n2. Envie para o destinat√°rio`)
        
      } else if (metodo === 'whatsapp') {
        // Compartilhar gr√°ficos selecionados por WhatsApp
        const mensagem = `üìä *GR√ÅFICOS SELECIONADOS DO REBANHO - BEEF SYNC*

üìÖ *Per√≠odo:* ${period.startDate} at√© ${period.endDate}
üêÑ *Total de Animais:* ${graficosData.resumo.total}

üìà *Gr√°ficos Inclu√≠dos:*
${graficosSelecionadosList.map(tipo => `‚Ä¢ ${nomesGraficos[tipo]}`).join('\n')}

üìä *Resumo do Per√≠odo:*
‚Ä¢ Per√≠odo: ${period.startDate} at√© ${period.endDate}
‚Ä¢ Total de animais: ${graficosData.resumo.total}
‚Ä¢ Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}

‚è∞ *Gerado em:* ${new Date().toLocaleString('pt-BR')}

_Sistema Beef Sync - Gest√£o de Rebanho_`
        
        // Preparar gr√°ficos selecionados para download
        const graficosParaDownload = graficosSelecionadosList.map(tipo => ({
          nome: nomesGraficos[tipo],
          base64: graficosData.graficos[tipo]
        }))

        // Tentar usar Web Share API para envio direto de m√∫ltiplos arquivos
        if (navigator.share && navigator.canShare) {
          try {
            const files = graficosParaDownload.map(grafico => {
              const byteCharacters = atob(grafico.base64)
              const byteNumbers = new Array(byteCharacters.length)
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i)
              }
              const byteArray = new Uint8Array(byteNumbers)
              const blob = new Blob([byteArray], { type: 'image/png' })
              return new File([blob], `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`, { type: 'image/png' })
            })

            await navigator.share({
              title: 'Gr√°ficos Selecionados do Rebanho - Beef Sync',
              text: mensagem,
              files: files
            })
            alert(`‚úÖ ${graficosSelecionadosList.length} gr√°fico(s) enviado(s) diretamente via WhatsApp!`)
            return
          } catch (error) {
            console.log('Web Share API falhou, tentando m√©todo alternativo')
          }
        }

        // M√©todo alternativo: download autom√°tico + WhatsApp Web
        graficosParaDownload.forEach((grafico, index) => {
          setTimeout(() => {
            const byteCharacters = atob(grafico.base64)
            const byteNumbers = new Array(byteCharacters.length)
            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i)
            }
            const byteArray = new Uint8Array(byteNumbers)
            const blob = new Blob([byteArray], { type: 'image/png' })
            
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`
            link.style.display = 'none'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
          }, index * 500) // Delay de 500ms entre cada download
        })

        // Codificar mensagem para URL
        const mensagemCodificada = encodeURIComponent(mensagem)
        const whatsappUrl = `https://web.whatsapp.com/send?text=${mensagemCodificada}`
        window.open(whatsappUrl, '_blank')
        
        alert(`‚úÖ WhatsApp Web aberto!\n‚úÖ ${graficosSelecionadosList.length} gr√°fico(s) baixado(s) automaticamente!\n\nüì± Agora:\n1. Anexe os gr√°ficos baixados no WhatsApp\n2. Cole tamb√©m a mensagem de texto\n3. Envie para o destinat√°rio`)
      }
      
    } catch (error) {
      console.error('Erro ao compartilhar gr√°ficos selecionados:', error)
      alert('‚ùå Erro ao compartilhar gr√°ficos selecionados: ' + error.message)
    }
  }

  const compartilharTodosGraficos = async (metodo) => {
    try {
      if (!graficosData) {
        alert('‚ùå Nenhum gr√°fico dispon√≠vel. Gere os gr√°ficos primeiro.')
        return
      }

      const graficos = [
        { tipo: 'porRaca', titulo: 'Distribui√ß√£o por Ra√ßa' },
        { tipo: 'porIdade', titulo: 'Distribui√ß√£o por Classifica√ß√£o Et√°ria' },
        { tipo: 'porSexo', titulo: 'Distribui√ß√£o por Sexo' },
        { tipo: 'porSituacao', titulo: 'Distribui√ß√£o por Situa√ß√£o' }
      ]

      if (metodo === 'email') {
        // Preparar todos os gr√°ficos para download
        const graficosParaDownload = [
          { nome: 'Distribui√ß√£o por Ra√ßa', base64: graficosData.graficos.porRaca },
          { nome: 'Distribui√ß√£o por Classifica√ß√£o Et√°ria', base64: graficosData.graficos.porIdade },
          { nome: 'Distribui√ß√£o por Sexo', base64: graficosData.graficos.porSexo },
          { nome: 'Distribui√ß√£o por Situa√ß√£o', base64: graficosData.graficos.porSituacao }
        ]

        // Tentar usar Web Share API para envio direto de m√∫ltiplos arquivos
        if (navigator.share && navigator.canShare) {
          try {
            const files = graficosParaDownload.map(grafico => {
              const byteCharacters = atob(grafico.base64)
              const byteNumbers = new Array(byteCharacters.length)
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i)
              }
              const byteArray = new Uint8Array(byteNumbers)
              const blob = new Blob([byteArray], { type: 'image/png' })
              return new File([blob], `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`, { type: 'image/png' })
            })

            await navigator.share({
              title: 'Todos os Gr√°ficos do Rebanho - Beef Sync',
              text: `Todos os gr√°ficos do rebanho referentes ao per√≠odo de ${period.startDate} at√© ${period.endDate}`,
              files: files
            })
            alert('‚úÖ Todos os gr√°ficos enviados diretamente por email!')
            return
          } catch (error) {
            console.log('Web Share API falhou, tentando m√©todo alternativo')
          }
        }

        // M√©todo alternativo: download autom√°tico + Outlook
        const assunto = `Todos os Gr√°ficos do Rebanho - ${period.startDate} at√© ${period.endDate}`
        const corpo = `
Ol√°!

Segue em anexo todos os gr√°ficos do rebanho referentes ao per√≠odo de ${period.startDate} at√© ${period.endDate}.

üìä GR√ÅFICOS INCLU√çDOS:
‚Ä¢ Distribui√ß√£o por Ra√ßa
‚Ä¢ Distribui√ß√£o por Classifica√ß√£o Et√°ria  
‚Ä¢ Distribui√ß√£o por Sexo
‚Ä¢ Distribui√ß√£o por Situa√ß√£o

üìà RESUMO DO PER√çODO:
‚Ä¢ Per√≠odo: ${period.startDate} at√© ${period.endDate}
‚Ä¢ Total de animais: ${graficosData.resumo.total}
‚Ä¢ Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}

Estes gr√°ficos foram gerados automaticamente pelo sistema Beef Sync.

Atenciosamente,
Sistema Beef Sync
        `.trim()
        
        const emailBody = encodeURIComponent(corpo)
        const emailSubject = encodeURIComponent(assunto)
        const outlookUrl = `mailto:?subject=${emailSubject}&body=${emailBody}`
        window.open(outlookUrl, '_blank')
        
        // Baixar todos os gr√°ficos automaticamente
        graficosParaDownload.forEach((grafico, index) => {
          setTimeout(() => {
            const byteCharacters = atob(grafico.base64)
            const byteNumbers = new Array(byteCharacters.length)
            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i)
            }
            const byteArray = new Uint8Array(byteNumbers)
            const blob = new Blob([byteArray], { type: 'image/png' })
            
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`
            link.style.display = 'none'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
          }, index * 500) // Delay de 500ms entre cada download
        })
        
        alert('‚úÖ Outlook aberto!\n‚úÖ Todos os 4 gr√°ficos baixados automaticamente!\n\nüìß Agora:\n1. Anexe os 4 gr√°ficos baixados no email\n2. Envie para o destinat√°rio')
        
      } else if (metodo === 'whatsapp') {
        // Compartilhar todos por WhatsApp
        const mensagem = `üìä *TODOS OS GR√ÅFICOS DO REBANHO - BEEF SYNC*

üìÖ *Per√≠odo:* ${period.startDate} at√© ${period.endDate}
üêÑ *Total de Animais:* ${graficosData.resumo.total}

üìà *Gr√°ficos Inclu√≠dos:*
‚Ä¢ Distribui√ß√£o por Ra√ßa
‚Ä¢ Distribui√ß√£o por Classifica√ß√£o Et√°ria
‚Ä¢ Distribui√ß√£o por Sexo  
‚Ä¢ Distribui√ß√£o por Situa√ß√£o

üìä *Resumo do Per√≠odo:*
‚Ä¢ Per√≠odo: ${period.startDate} at√© ${period.endDate}
‚Ä¢ Total de animais: ${graficosData.resumo.total}
‚Ä¢ Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}

‚è∞ *Gerado em:* ${new Date().toLocaleString('pt-BR')}

_Sistema Beef Sync - Gest√£o de Rebanho_`
        
        // Preparar todos os gr√°ficos para download
        const graficosParaDownload = [
          { nome: 'Distribui√ß√£o por Ra√ßa', base64: graficosData.graficos.porRaca },
          { nome: 'Distribui√ß√£o por Classifica√ß√£o Et√°ria', base64: graficosData.graficos.porIdade },
          { nome: 'Distribui√ß√£o por Sexo', base64: graficosData.graficos.porSexo },
          { nome: 'Distribui√ß√£o por Situa√ß√£o', base64: graficosData.graficos.porSituacao }
        ]

        // Tentar usar Web Share API para envio direto de m√∫ltiplos arquivos
        if (navigator.share && navigator.canShare) {
          try {
            const files = graficosParaDownload.map(grafico => {
              const byteCharacters = atob(grafico.base64)
              const byteNumbers = new Array(byteCharacters.length)
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i)
              }
              const byteArray = new Uint8Array(byteNumbers)
              const blob = new Blob([byteArray], { type: 'image/png' })
              return new File([blob], `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`, { type: 'image/png' })
            })

            await navigator.share({
              title: 'Todos os Gr√°ficos do Rebanho - Beef Sync',
              text: mensagem,
              files: files
            })
            alert('‚úÖ Todos os gr√°ficos enviados diretamente via WhatsApp!')
            return
          } catch (error) {
            console.log('Web Share API falhou, tentando m√©todo alternativo')
          }
        }

        // M√©todo alternativo: download autom√°tico + WhatsApp Web
        graficosParaDownload.forEach((grafico, index) => {
          setTimeout(() => {
            const byteCharacters = atob(grafico.base64)
            const byteNumbers = new Array(byteCharacters.length)
            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i)
            }
            const byteArray = new Uint8Array(byteNumbers)
            const blob = new Blob([byteArray], { type: 'image/png' })
            
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = `grafico_${grafico.nome.replace(/[^a-zA-Z0-9]/g, '_')}.png`
            link.style.display = 'none'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
          }, index * 500) // Delay de 500ms entre cada download
        })

        // Codificar mensagem para URL
        const mensagemCodificada = encodeURIComponent(mensagem)
        const whatsappUrl = `https://web.whatsapp.com/send?text=${mensagemCodificada}`
        window.open(whatsappUrl, '_blank')
        
        alert('‚úÖ WhatsApp Web aberto!\n‚úÖ Todos os 4 gr√°ficos baixados automaticamente!\n\nüì± Agora:\n1. Anexe os 4 gr√°ficos baixados no WhatsApp\n2. Cole tamb√©m a mensagem de texto\n3. Envie para o destinat√°rio')
      }
      
    } catch (error) {
      console.error('Erro ao compartilhar todos os gr√°ficos:', error)
      alert('‚ùå Erro ao compartilhar todos os gr√°ficos: ' + error.message)
    }
  }

  const downloadNotasFiscais = async () => {
    try {
      setLoading(true)
      
      const response = await fetch('/api/contabilidade/notas-fiscais', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ period })
      })

      if (!response.ok) throw new Error('Erro ao gerar relat√≥rio de NFs')
      
      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `notas-fiscais-${period.startDate}-${period.endDate}.xlsx`
      document.body.appendChild(a)
      a.click()
      window.URL.revokeObjectURL(url)
      document.body.removeChild(a)
      
      alert('‚úÖ Sucesso! Relat√≥rio de Notas Fiscais baixado com sucesso!')
    } catch (error) {
      console.error('Erro:', error)
      alert('‚ùå Erro: N√£o foi poss√≠vel gerar o relat√≥rio de notas fiscais')
    } finally {
      setLoading(false)
    }
  }

  const downloadMovimentacoes = async () => {
    try {
      setLoading(true)
      
      const response = await fetch('/api/contabilidade/movimentacoes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ period })
      })

      if (!response.ok) throw new Error('Erro ao gerar relat√≥rio de movimenta√ß√µes')
      
      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `movimentacoes-${period.startDate}-${period.endDate}.xlsx`
      document.body.appendChild(a)
      a.click()
      window.URL.revokeObjectURL(url)
      document.body.removeChild(a)
      
      alert('‚úÖ Sucesso! Relat√≥rio de Movimenta√ß√µes baixado com sucesso!')
    } catch (error) {
      console.error('Erro:', error)
      alert('‚ùå Erro: N√£o foi poss√≠vel gerar o relat√≥rio de movimenta√ß√µes')
    } finally {
      setLoading(false)
    }
  }

  const sendAllReports = async () => {
    if (selectedRecipients.length === 0) {
      alert('‚ö†Ô∏è Aten√ß√£o: Selecione pelo menos um destinat√°rio')
      return
    }

    try {
      setLoading(true)
      
      const selectedRecipientsData = recipients.filter(r => 
        selectedRecipients.includes(r.id)
      )
      
      const response = await fetch('/api/contabilidade/enviar-relatorios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          period,
          recipients: selectedRecipientsData
        })
      })

      if (!response.ok) throw new Error('Erro ao enviar relat√≥rios')
      
      alert(`‚úÖ Sucesso! Relat√≥rios enviados para ${selectedRecipientsData.length} destinat√°rio(s)!`)
    } catch (error) {
      console.error('Erro:', error)
      alert('‚ùå Erro: N√£o foi poss√≠vel enviar os relat√≥rios')
    } finally {
      setLoading(false)
    }
  }

  return (
    <ModernLayout
      title="Relat√≥rios para Contabilidade"
      subtitle="Gere e envie relat√≥rios completos para sua equipe cont√°bil"
      icon="üìä"
    >
      <div className="space-y-8">

        {/* Estat√≠sticas R√°pidas */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <StatsCard
            title="Total de Animais"
            value={reportStats.totalAnimals}
            subtitle="Rebanho cadastrado"
            icon={<UserGroupIcon className="h-6 w-6" />}
            color="blue"
            onClick={() => setShowCardDetails('total-animais')}
          />

          <StatsCard
            title="NFs de Entrada"
            value={reportStats.nfsEntradas}
            subtitle="Compras e aquisi√ß√µes"
            icon={<TruckIcon className="h-6 w-6" />}
            color="green"
            onClick={() => router.push('/notas-fiscais?tipo=entrada')}
          />

          <StatsCard
            title="NFs de Sa√≠da"
            value={reportStats.nfsSaidas}
            subtitle="Vendas e transfer√™ncias"
            icon={<TruckIcon className="h-6 w-6" />}
            color="red"
            onClick={() => router.push('/notas-fiscais?tipo=saida')}
          />

          <StatsCard
            title="Total Movimenta√ß√µes"
            value={reportStats.movimentacoes}
            subtitle="Entradas + Sa√≠das"
            icon={<ChartBarIcon className="h-6 w-6" />}
            color="purple"
            onClick={() => router.push('/notas-fiscais')}
          />
        </div>

        {/* Gr√°ficos Visuais */}
        <ModernCard variant="gradient" className="mb-8">
          <ModernCardHeader
            icon={<ChartBarIcon className="h-6 w-6" />}
            title="Gr√°ficos Visuais do Rebanho"
            subtitle="Visualize dados do rebanho em gr√°ficos interativos"
          />
          <ModernCardBody>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <Button
                variant="primary"
                size="md"
                onClick={() => gerarGraficos()}
                loading={loading}
                modern={true}
                glow={true}
                leftIcon={<ChartBarIcon className="h-5 w-5" />}
              >
                Gerar Gr√°ficos
              </Button>
              <Button
                variant="secondary"
                size="md"
                onClick={() => setShowGraficos(!showGraficos)}
                modern={true}
                leftIcon={showGraficos ? 'üëÅÔ∏è' : 'üëÅÔ∏è'}
              >
                {showGraficos ? 'Ocultar Gr√°ficos' : 'Visualizar Gr√°ficos'}
              </Button>
            </div>

          {showGraficos && graficosData && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Gr√°fico por Ra√ßa */}
              <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 text-center">
                  üêÑ Distribui√ß√£o por Ra√ßa
                </h4>
                <div className="flex justify-center">
                  <img 
                    src={`data:image/png;base64,${graficosData.graficos.porRaca}`} 
                    alt="Gr√°fico por Ra√ßa"
                    className="max-w-full h-auto rounded"
                  />
                </div>
                <div className="mt-2 text-center space-y-2">
                  <div className="flex space-x-2 justify-center">
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGrafico('porRaca', 'Distribui√ß√£o por Ra√ßa')}
                      className="bg-blue-600 hover:bg-blue-700 text-xs"
                    >
                      üìß Email
                    </Button>
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGraficoWhatsApp('porRaca', 'Distribui√ß√£o por Ra√ßa')}
                      className="bg-green-500 hover:bg-green-600 text-xs"
                    >
                      üí¨ WhatsApp
                    </Button>
                  </div>
                </div>
              </div>

              {/* Gr√°fico por Idade */}
              <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 text-center">
                  üìÖ Distribui√ß√£o por Classifica√ß√£o Et√°ria
                </h4>
                <div className="flex justify-center">
                  <img 
                    src={`data:image/png;base64,${graficosData.graficos.porIdade}`} 
                    alt="Gr√°fico por Idade"
                    className="max-w-full h-auto rounded"
                  />
                </div>
                <div className="mt-2 text-center space-y-2">
                  <div className="flex space-x-2 justify-center">
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGrafico('porIdade', 'Distribui√ß√£o por Classifica√ß√£o Et√°ria')}
                      className="bg-blue-600 hover:bg-blue-700 text-xs"
                    >
                      üìß Email
                    </Button>
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGraficoWhatsApp('porIdade', 'Distribui√ß√£o por Classifica√ß√£o Et√°ria')}
                      className="bg-green-500 hover:bg-green-600 text-xs"
                    >
                      üí¨ WhatsApp
                    </Button>
                  </div>
                </div>
              </div>

              {/* Gr√°fico por Sexo */}
              <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 text-center">
                  ‚ôÇÔ∏è‚ôÄÔ∏è Distribui√ß√£o por Sexo
                </h4>
                <div className="flex justify-center">
                  <img 
                    src={`data:image/png;base64,${graficosData.graficos.porSexo}`} 
                    alt="Gr√°fico por Sexo"
                    className="max-w-full h-auto rounded"
                  />
                </div>
                <div className="mt-2 text-center space-y-2">
                  <div className="flex space-x-2 justify-center">
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGrafico('porSexo', 'Distribui√ß√£o por Sexo')}
                      className="bg-blue-600 hover:bg-blue-700 text-xs"
                    >
                      üìß Email
                    </Button>
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGraficoWhatsApp('porSexo', 'Distribui√ß√£o por Sexo')}
                      className="bg-green-500 hover:bg-green-600 text-xs"
                    >
                      üí¨ WhatsApp
                    </Button>
                  </div>
                </div>
              </div>

              {/* Gr√°fico por Situa√ß√£o */}
              <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 text-center">
                  üìä Distribui√ß√£o por Situa√ß√£o
                </h4>
                <div className="flex justify-center">
                  <img 
                    src={`data:image/png;base64,${graficosData.graficos.porSituacao}`} 
                    alt="Gr√°fico por Situa√ß√£o"
                    className="max-w-full h-auto rounded"
                  />
                </div>
                <div className="mt-2 text-center space-y-2">
                  <div className="flex space-x-2 justify-center">
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGrafico('porSituacao', 'Distribui√ß√£o por Situa√ß√£o')}
                      className="bg-blue-600 hover:bg-blue-700 text-xs"
                    >
                      üìß Email
                    </Button>
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => compartilharGraficoWhatsApp('porSituacao', 'Distribui√ß√£o por Situa√ß√£o')}
                      className="bg-green-500 hover:bg-green-600 text-xs"
                    >
                      üí¨ WhatsApp
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          )}
          </ModernCardBody>
        </ModernCard>

      {/* Compartilhamento R√°pido */}
      <Card className="bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-900/20 dark:to-green-900/20 border-blue-200 dark:border-blue-700 mb-6">
        <CardHeader>
          <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
            <PaperAirplaneIcon className="h-5 w-5 mr-2 text-blue-600" />
            üöÄ Compartilhamento R√°pido
          </h3>
        </CardHeader>
        <CardBody>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {/* Compartilhar Boletim */}
            <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
              <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                üìä Boletim de Gado
              </h4>
              <div className="grid grid-cols-2 gap-2">
                <Button
                  variant="primary"
                  size="sm"
                  onClick={() => enviarPorEmail()}
                  className="bg-blue-600 hover:bg-blue-700 text-xs"
                >
                  üìß Email
                </Button>
                <Button
                  variant="primary"
                  size="sm"
                  onClick={() => enviarPorWhatsApp()}
                  className="bg-green-500 hover:bg-green-600 text-xs"
                >
                  üí¨ WhatsApp
                </Button>
              </div>
            </div>

            {/* Compartilhar NFs */}
            <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
              <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                üìÑ Notas Fiscais
              </h4>
              <div className="grid grid-cols-2 gap-2">
                <Button
                  variant="primary"
                  size="sm"
                  onClick={() => enviarNFsPorEmail()}
                  className="bg-blue-600 hover:bg-blue-700 text-xs"
                >
                  üìß Email
                </Button>
                <Button
                  variant="primary"
                  size="sm"
                  onClick={() => enviarNFsPorWhatsApp()}
                  className="bg-green-500 hover:bg-green-600 text-xs"
                >
                  üí¨ WhatsApp
                </Button>
              </div>
            </div>

            {/* Compartilhamento Geral */}
            <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
              <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                üîó Compartilhar Sistema
              </h4>
              <div className="grid grid-cols-2 gap-2">
                <Button
                  variant="secondary"
                  size="sm"
                  onClick={() => compartilharSistema()}
                  className="text-xs"
                >
                  üîó Link
                </Button>
                <Button
                  variant="secondary"
                  size="sm"
                  onClick={() => copiarResumo()}
                  className="text-xs"
                >
                  üìã Copiar
                </Button>
              </div>
            </div>
          </div>

          {/* Compartilhamento de Gr√°ficos */}
          {graficosData && (
            <div className="mt-4">
              <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                üìä Compartilhar Gr√°ficos
              </h4>
              
              {/* Sele√ß√£o de Gr√°ficos */}
              <div className="mb-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg border border-purple-200 dark:border-purple-700">
                <h5 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  ‚òëÔ∏è Selecionar Gr√°ficos para Envio
                </h5>
                <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                  Marque os gr√°ficos que deseja enviar
                </p>
                
                {/* Checkboxes dos Gr√°ficos */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                  <label className="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                    <input
                      type="checkbox"
                      checked={graficosSelecionados.porRaca}
                      onChange={() => handleGraficoSelecionado('porRaca')}
                      className="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                    />
                    <span className="text-sm font-medium text-gray-900 dark:text-white">üêÑ Ra√ßas</span>
                  </label>
                  
                  <label className="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                    <input
                      type="checkbox"
                      checked={graficosSelecionados.porIdade}
                      onChange={() => handleGraficoSelecionado('porIdade')}
                      className="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                    />
                    <span className="text-sm font-medium text-gray-900 dark:text-white">üìÖ Classifica√ß√£o</span>
                  </label>
                  
                  <label className="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                    <input
                      type="checkbox"
                      checked={graficosSelecionados.porSexo}
                      onChange={() => handleGraficoSelecionado('porSexo')}
                      className="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                    />
                    <span className="text-sm font-medium text-gray-900 dark:text-white">‚ôÇÔ∏è‚ôÄÔ∏è Sexo</span>
                  </label>
                  
                  <label className="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                    <input
                      type="checkbox"
                      checked={graficosSelecionados.porSituacao}
                      onChange={() => handleGraficoSelecionado('porSituacao')}
                      className="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                    />
                    <span className="text-sm font-medium text-gray-900 dark:text-white">üìä Situa√ß√£o</span>
                  </label>
                </div>
                
                {/* Bot√µes de Controle */}
                <div className="flex flex-wrap gap-2 mb-4">
                  <Button
                    variant="secondary"
                    size="sm"
                    onClick={selecionarTodosGraficos}
                    className="bg-gray-500 hover:bg-gray-600 text-xs"
                  >
                    ‚òëÔ∏è Selecionar Todos
                  </Button>
                  <Button
                    variant="secondary"
                    size="sm"
                    onClick={desmarcarTodosGraficos}
                    className="bg-gray-500 hover:bg-gray-600 text-xs"
                  >
                    ‚òê Desmarcar Todos
                  </Button>
                </div>
                
                {/* Bot√µes de Envio */}
                <div className="grid grid-cols-2 gap-2">
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGraficosSelecionados('email')}
                    className="bg-blue-600 hover:bg-blue-700 text-xs"
                    disabled={Object.values(graficosSelecionados).every(v => !v)}
                  >
                    üìß Enviar Selecionados por Email
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGraficosSelecionados('whatsapp')}
                    className="bg-green-500 hover:bg-green-600 text-xs"
                    disabled={Object.values(graficosSelecionados).every(v => !v)}
                  >
                    üí¨ Enviar Selecionados por WhatsApp
                  </Button>
                </div>
              </div>

              {/* Compartilhamento em Lote */}
              <div className="mb-4 p-4 bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-900/20 dark:to-green-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                <h5 className="font-semibold text-gray-900 dark:text-white mb-2 flex items-center">
                  üì¶ Enviar Todos os Gr√°ficos
                </h5>
                <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                  Envie todos os 4 gr√°ficos de uma vez por email ou WhatsApp
                </p>
                <div className="grid grid-cols-2 gap-2">
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharTodosGraficos('email')}
                    className="bg-blue-600 hover:bg-blue-700 text-xs"
                  >
                    üìß Todos por Email
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharTodosGraficos('whatsapp')}
                    className="bg-green-500 hover:bg-green-600 text-xs"
                  >
                    üí¨ Todos por WhatsApp
                  </Button>
                </div>
              </div>

              {/* Compartilhamento Individual */}
              <div className="space-y-3">
                <div className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                  üìß Compartilhar Individual por Email:
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGrafico('porRaca', 'Distribui√ß√£o por Ra√ßa')}
                    className="bg-purple-600 hover:bg-purple-700 text-xs"
                  >
                    üêÑ Ra√ßas
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGrafico('porIdade', 'Distribui√ß√£o por Classifica√ß√£o Et√°ria')}
                    className="bg-purple-600 hover:bg-purple-700 text-xs"
                  >
                    üìÖ Classifica√ß√£o
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGrafico('porSexo', 'Distribui√ß√£o por Sexo')}
                    className="bg-purple-600 hover:bg-purple-700 text-xs"
                  >
                    ‚ôÇÔ∏è‚ôÄÔ∏è Sexo
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGrafico('porSituacao', 'Distribui√ß√£o por Situa√ß√£o')}
                    className="bg-purple-600 hover:bg-purple-700 text-xs"
                  >
                    üìä Situa√ß√£o
                  </Button>
                </div>
                
                <div className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                  üí¨ Compartilhar Individual por WhatsApp:
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGraficoWhatsApp('porRaca', 'Distribui√ß√£o por Ra√ßa')}
                    className="bg-green-500 hover:bg-green-600 text-xs"
                  >
                    üêÑ Ra√ßas
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGraficoWhatsApp('porIdade', 'Distribui√ß√£o por Classifica√ß√£o Et√°ria')}
                    className="bg-green-500 hover:bg-green-600 text-xs"
                  >
                    üìÖ Classifica√ß√£o
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGraficoWhatsApp('porSexo', 'Distribui√ß√£o por Sexo')}
                    className="bg-green-500 hover:bg-green-600 text-xs"
                  >
                    ‚ôÇÔ∏è‚ôÄÔ∏è Sexo
                  </Button>
                  <Button
                    variant="primary"
                    size="sm"
                    onClick={() => compartilharGraficoWhatsApp('porSituacao', 'Distribui√ß√£o por Situa√ß√£o')}
                    className="bg-green-500 hover:bg-green-600 text-xs"
                  >
                    üìä Situa√ß√£o
                  </Button>
                </div>
              </div>
            </div>
          )}
        </CardBody>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Configura√ß√£o do Per√≠odo */}
        <div className="lg:col-span-2 space-y-6">
          <Card>
            <CardHeader>
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <CalendarIcon className="h-5 w-5 mr-2" />
                Per√≠odo de Refer√™ncia
              </h3>
            </CardHeader>
            <CardBody>
              <div className="grid grid-cols-2 gap-4">
                <Input
                  label="Data Inicial"
                  type="date"
                  value={period.startDate}
                  onChange={(e) => setPeriod(prev => ({ ...prev, startDate: e.target.value }))}
                />
                <Input
                  label="Data Final"
                  type="date"
                  value={period.endDate}
                  onChange={(e) => setPeriod(prev => ({ ...prev, endDate: e.target.value }))}
                />
              </div>
              
              <div className="mt-4 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <p className="text-sm text-blue-800 dark:text-blue-200">
                  üí° <strong>Dica:</strong> Os relat√≥rios incluir√£o todas as movimenta√ß√µes e dados 
                  referentes ao per√≠odo selecionado.
                </p>
              </div>
            </CardBody>
          </Card>

          {/* Relat√≥rios Dispon√≠veis */}
          <ModernCard modern={true} hover={true}>
            <ModernCardHeader
              icon={<DocumentTextIcon className="h-6 w-6" />}
              title="Relat√≥rios Dispon√≠veis"
              subtitle="Gere e compartilhe relat√≥rios profissionais"
            />
            <ModernCardBody>
              <div className="space-y-6">
                {/* Boletim de Gado */}
                <ReportCard
                  title="Boletim de Gado"
                  description="Relat√≥rio detalhado do rebanho por ra√ßa e faixas de idade"
                  icon={<TableCellsIcon className="h-5 w-5" />}
                  iconColor="from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20"
                  onDownload={() => handleDownloadBoletim(false)}
                  onSendToAccounting={() => handleDownloadBoletim(true)}
                  onEmail={handleEnviarEmail}
                  onWhatsApp={handleEnviarWhatsApp}
                  loading={loading}
                >
                  {/* Resumo dos Animais */}
                  <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
                    <div className="flex items-center justify-between mb-2">
                      <h5 className="text-sm font-medium text-blue-800 dark:text-blue-200">
                        üìä Resumo Atual do Rebanho
                      </h5>
                      <button
                        onClick={loadResumoAnimais}
                        className="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors"
                        title="Atualizar resumo"
                      >
                        üîÑ Atualizar
                      </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                      {/* Total */}
                      <div className="text-center">
                        <div className="text-lg font-bold text-blue-600 dark:text-blue-400">
                          {resumoAnimais.totalAnimais}
                        </div>
                        <div className="text-blue-700 dark:text-blue-300">Total</div>
                      </div>
                      
                      {/* Por Sexo */}
                      <div className="text-center">
                        <div className="space-y-1">
                          {Object.entries(resumoAnimais.porSexo).map(([sexo, quantidade]) => (
                            <div key={sexo} className="flex justify-between">
                              <span className="text-blue-700 dark:text-blue-300">{sexo}:</span>
                              <span className="font-medium text-blue-600 dark:text-blue-400">{quantidade}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* Por Ra√ßa */}
                      <div className="text-center">
                        <div className="space-y-1 max-h-16 overflow-y-auto">
                          {Object.entries(resumoAnimais.porRaca).slice(0, 3).map(([raca, quantidade]) => (
                            <div key={raca} className="flex justify-between">
                              <span className="text-blue-700 dark:text-blue-300 truncate">{raca}:</span>
                              <span className="font-medium text-blue-600 dark:text-blue-400">{quantidade}</span>
                            </div>
                          ))}
                          {Object.keys(resumoAnimais.porRaca).length > 3 && (
                            <div className="text-blue-600 dark:text-blue-400 text-xs">
                              +{Object.keys(resumoAnimais.porRaca).length - 3} mais
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </ReportCard>

                {/* Notas Fiscais */}
                <ReportCard
                  title="Notas Fiscais"
                  description="Compilado de todas as NFs de entrada e sa√≠da do per√≠odo, incluindo valores, datas, destinos/origens e naturezas de opera√ß√£o"
                  icon={<DocumentTextIcon className="h-5 w-5" />}
                  iconColor="from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20"
                  onDownload={handleDownloadNFs}
                  onSendToAccounting={handleDownloadNFs}
                  onEmail={() => enviarNFsPorEmail()}
                  onWhatsApp={() => enviarNFsPorWhatsApp()}
                  loading={loading}
                />

                {/* Movimenta√ß√µes */}
                <ReportCard
                  title="Movimenta√ß√µes do M√™s"
                  description="Resumo completo de todas as movimenta√ß√µes: vendas, compras, transfer√™ncias, mortes e outras sa√≠das/entradas do rebanho"
                  icon={<TruckIcon className="h-5 w-5" />}
                  iconColor="from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20"
                  onDownload={() => downloadMovimentacoes()}
                  loading={loading}
                />
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Relat√≥rio detalhado do rebanho por ra√ßa e faixas de idade:
                      </p>
                      <ul className="text-sm text-gray-600 dark:text-gray-400 space-y-1 ml-4 mb-4">
                        <li>‚Ä¢ 0 a 3 meses</li>
                        <li>‚Ä¢ 4 a 7 meses</li>
                        <li>‚Ä¢ 8 a 12 meses</li>
                        <li>‚Ä¢ 13 a 24 meses</li>
                        <li>‚Ä¢ 25 a 36 meses</li>
                        <li>‚Ä¢ 37 meses ou mais</li>
                      </ul>

                      {/* Resumo dos Animais */}
                      <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
                        <div className="flex items-center justify-between mb-2">
                          <h5 className="text-sm font-medium text-blue-800 dark:text-blue-200">
                            üìä Resumo Atual do Rebanho
                          </h5>
                          <button
                            onClick={loadResumoAnimais}
                            className="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors"
                            title="Atualizar resumo"
                          >
                            üîÑ Atualizar
                          </button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                          {/* Total */}
                          <div className="text-center">
                            <div className="text-lg font-bold text-blue-600 dark:text-blue-400">
                              {resumoAnimais.totalAnimais}
                            </div>
                            <div className="text-blue-700 dark:text-blue-300">Total</div>
                          </div>
                          
                          {/* Por Sexo */}
                          <div className="text-center">
                            <div className="space-y-1">
                              {Object.entries(resumoAnimais.porSexo).map(([sexo, quantidade]) => (
                                <div key={sexo} className="flex justify-between">
                                  <span className="text-blue-700 dark:text-blue-300">{sexo}:</span>
                                  <span className="font-medium text-blue-600 dark:text-blue-400">{quantidade}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                          
                          {/* Por Ra√ßa */}
                          <div className="text-center">
                            <div className="space-y-1 max-h-16 overflow-y-auto">
                              {Object.entries(resumoAnimais.porRaca).slice(0, 3).map(([raca, quantidade]) => (
                                <div key={raca} className="flex justify-between">
                                  <span className="text-blue-700 dark:text-blue-300 truncate">{raca}:</span>
                                  <span className="font-medium text-blue-600 dark:text-blue-400">{quantidade}</span>
                                </div>
                              ))}
                              {Object.keys(resumoAnimais.porRaca).length > 3 && (
                                <div className="text-blue-600 dark:text-blue-400 text-xs">
                                  +{Object.keys(resumoAnimais.porRaca).length - 3} mais
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <Button
                        variant="secondary"
                        size="sm"
                        leftIcon={<DocumentArrowDownIcon className="h-4 w-4" />}
                        onClick={() => downloadBoletimGado(false)}
                        loading={loading}
                        modern={true}
                      >
                        Baixar Excel
                      </Button>
                      <Button
                        variant="success"
                        size="sm"
                        leftIcon={<PaperAirplaneIcon className="h-4 w-4" />}
                        onClick={() => downloadBoletimGado(true)}
                        loading={loading}
                        modern={true}
                        glow={true}
                      >
                        Contabilidade
                      </Button>
                      <Button
                        variant="primary"
                        size="sm"
                        leftIcon={<EnvelopeIcon className="h-4 w-4" />}
                        onClick={() => enviarPorEmail()}
                        loading={loading}
                        modern={true}
                      >
                        Email
                      </Button>
                      <Button
                        variant="success"
                        size="sm"
                        leftIcon={<ChatBubbleLeftRightIcon className="h-4 w-4" />}
                        onClick={() => enviarPorWhatsApp()}
                        loading={loading}
                        modern={true}
                      >
                        WhatsApp
                      </Button>
                    </div>
                  </div>
                </div>

                {/* Notas Fiscais */}
                <div className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-200 dark:border-green-800 rounded-2xl p-6 hover:shadow-lg transition-all duration-300">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center space-x-3 mb-3">
                        <div className="p-2 bg-green-500 rounded-xl text-white">
                          <DocumentTextIcon className="h-5 w-5" />
                        </div>
                        <h4 className="text-lg font-bold text-gray-900 dark:text-white">
                          Notas Fiscais
                        </h4>
                      </div>
                      <p className="text-sm text-gray-600 dark:text-gray-400">
                        Compilado de todas as NFs de entrada e sa√≠da do per√≠odo, incluindo:
                        valores, datas, destinos/origens e naturezas de opera√ß√£o.
                      </p>
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      <Button
                        variant="secondary"
                        size="sm"
                        leftIcon={<DocumentArrowDownIcon className="h-4 w-4" />}
                        onClick={downloadNotasFiscais}
                        loading={loading}
                      >
                        üì• Baixar Excel
                      </Button>
                      <Button
                        variant="primary"
                        size="sm"
                        leftIcon={<EnvelopeIcon className="h-4 w-4" />}
                        onClick={() => enviarNFsPorEmail()}
                        loading={loading}
                        className="bg-blue-600 hover:bg-blue-700"
                      >
                        üìß Email
                      </Button>
                      <Button
                        variant="primary"
                        size="sm"
                        leftIcon={<ChatBubbleLeftRightIcon className="h-4 w-4" />}
                        onClick={() => enviarNFsPorWhatsApp()}
                        loading={loading}
                        className="bg-green-500 hover:bg-green-600"
                      >
                        üí¨ WhatsApp
                      </Button>
                      <Button
                        variant="primary"
                        size="sm"
                        leftIcon={<PaperAirplaneIcon className="h-4 w-4" />}
                        onClick={() => downloadNotasFiscais()}
                        loading={loading}
                        className="bg-green-600 hover:bg-green-700"
                      >
                        üìä Contabilidade
                      </Button>
                    </div>
                  </div>
                </div>

                {/* Movimenta√ß√µes */}
                <div className="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border border-purple-200 dark:border-purple-800 rounded-2xl p-6 hover:shadow-lg transition-all duration-300">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center space-x-3 mb-3">
                        <div className="p-2 bg-purple-500 rounded-xl text-white">
                          <TruckIcon className="h-5 w-5" />
                        </div>
                        <h4 className="text-lg font-bold text-gray-900 dark:text-white">
                          Movimenta√ß√µes do M√™s
                        </h4>
                      </div>
                      <p className="text-sm text-gray-600 dark:text-gray-400">
                        Resumo completo de todas as movimenta√ß√µes: vendas, compras, transfer√™ncias,
                        mortes e outras sa√≠das/entradas do rebanho.
                      </p>
                    </div>
                    <Button
                      variant="secondary"
                      size="sm"
                      leftIcon={<DocumentArrowDownIcon className="h-4 w-4" />}
                      onClick={downloadMovimentacoes}
                      loading={loading}
                    >
                      Baixar Excel
                    </Button>
                  </div>
                </div>
              </div>
            </ModernCardBody>
          </ModernCard>
        </div>

        {/* Painel de Destinat√°rios */}
        <div className="space-y-6">
          <RecipientsList
            recipients={recipients}
            selectedRecipients={selectedRecipients}
            onToggleRecipient={handleRecipientToggle}
            onRemoveRecipient={removeRecipient}
            onAddRecipient={() => setShowAddRecipient(true)}
          />
              {recipients.length === 0 ? (
                <div className="text-center py-8">
                  <UserGroupIcon className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                  <p className="text-gray-500 dark:text-gray-400 mb-4">
                    Nenhum destinat√°rio cadastrado
                  </p>
                  <Button
                    variant="primary"
                    onClick={() => setShowAddRecipient(true)}
                    leftIcon={<PlusIcon className="h-4 w-4" />}
                  >
                    Adicionar Destinat√°rio
                  </Button>
                </div>
              ) : (
                <div className="space-y-3">
                  {recipients.map((recipient) => (
                    <div
                      key={recipient.id}
                      className={`p-3 rounded-lg border transition-colors ${
                        selectedRecipients.includes(recipient.id)
                          ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                          : 'border-gray-200 dark:border-gray-700'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <h4 className="font-medium text-gray-900 dark:text-white">
                            {recipient.name}
                          </h4>
                          {recipient.email && (
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                              üìß {recipient.email}
                            </p>
                          )}
                          {recipient.whatsapp && (
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                              üì± {recipient.whatsapp}
                            </p>
                          )}
                          <span className="inline-block mt-1 px-2 py-1 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                            {recipient.role}
                          </span>
                        </div>
                        <div className="flex items-center space-x-2">
                          <input
                            type="checkbox"
                            checked={selectedRecipients.includes(recipient.id)}
                            onChange={() => handleRecipientToggle(recipient.id)}
                            className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                          />
                          <button
                            onClick={() => removeRecipient(recipient.id)}
                            className="text-red-500 hover:text-red-700 p-1"
                            title="Remover destinat√°rio"
                          >
                            <TrashIcon className="h-4 w-4" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </ModernCardBody>
          </ModernCard>

          {/* A√ß√µes */}
          <ModernCard variant="premium" modern={true} hover={true} glow={true}>
            <ModernCardHeader
              icon={<PaperAirplaneIcon className="h-6 w-6" />}
              title="Enviar Relat√≥rios"
              subtitle="Envie todos os relat√≥rios de uma vez"
            />
            <ModernCardBody>
              <div className="space-y-3">
                <Button
                  variant="primary"
                  size="lg"
                  className="w-full"
                  leftIcon={<PaperAirplaneIcon className="h-5 w-5" />}
                  onClick={handleSendAllReports}
                  loading={loading}
                  disabled={selectedRecipients.length === 0}
                  modern={true}
                  glow={true}
                >
                  Enviar Todos os Relat√≥rios
                </Button>
                
                {selectedRecipients.length > 0 && (
                  <div className="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg">
                    <p className="text-sm text-green-800 dark:text-green-200">
                      ‚úì {selectedRecipients.length} destinat√°rio(s) selecionado(s)
                    </p>
                  </div>
                )}

                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                  <p className="text-xs text-blue-800 dark:text-blue-200">
                    üí° Os 3 relat√≥rios (Boletim de Gado, Notas Fiscais e Movimenta√ß√µes) 
                    ser√£o enviados automaticamente para os destinat√°rios selecionados.
                  </p>
                </div>
              </div>
            </ModernCardBody>
          </ModernCard>
        </div>
      </div>

      {/* Modal Adicionar Destinat√°rio */}
      <Modal
        isOpen={showAddRecipient}
        onClose={() => {
          setShowAddRecipient(false)
          setNewRecipient({ name: '', email: '', whatsapp: '', role: 'Contador' })
        }}
        title="Adicionar Destinat√°rio"
        size="md"
      >
        <div className="space-y-4">
          <Input
            label="üìù Nome Completo"
            value={newRecipient.name}
            onChange={(e) => setNewRecipient(prev => ({ ...prev, name: e.target.value }))}
            placeholder="Ex: Jo√£o Silva"
            required
          />
          
          <Input
            label="üìß Email"
            type="email"
            value={newRecipient.email}
            onChange={(e) => setNewRecipient(prev => ({ ...prev, email: e.target.value }))}
            placeholder="Ex: contador@empresa.com.br"
          />
          
          <Input
            label="üì± WhatsApp (opcional)"
            value={newRecipient.whatsapp}
            onChange={(e) => setNewRecipient(prev => ({ ...prev, whatsapp: e.target.value }))}
            placeholder="Ex: (11) 99999-9999"
          />
          
          <Input
            label="üë§ Fun√ß√£o/Cargo"
            value={newRecipient.role}
            onChange={(e) => setNewRecipient(prev => ({ ...prev, role: e.target.value }))}
            placeholder="Ex: Contador, Escrit√≥rio Cont√°bil"
          />

          <div className="flex space-x-3 pt-4">
            <Button
              variant="primary"
              className="flex-1"
              onClick={addRecipient}
              modern={true}
            >
              Adicionar
            </Button>
            <Button
              variant="secondary"
              className="flex-1"
              onClick={resetForm}
              modern={true}
            >
              Cancelar
            </Button>
          </div>
        </div>
      </Modal>

      {/* Modal de Detalhes dos Cards - NFs de Entrada/Sa√≠da/Movimenta√ß√µes */}
      {console.log('üîç Estado do modal de cards - showCardDetails:', showCardDetails)}
      {showCardDetails && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div className="p-6 border-b border-gray-200 dark:border-gray-700">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                  {getCardDetailsTitle(showCardDetails)}
                </h3>
                <button
                  onClick={() => setShowCardDetails(null)}
                  className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                >
                  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6">
              {getCardDetailsContent(showCardDetails, { nfsEntradasData, nfsSaidasData, reportStats, navegarParaEdicaoNF, animaisData })}
            </div>

            <div className="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
              <Button
                variant="secondary"
                onClick={() => setShowCardDetails(null)}
              >
                Fechar
              </Button>
            </div>
          </div>
        </div>
      )}
      </div>
    </ModernLayout>
  )
}

function getCardDetailsTitle(cardType) {
  switch (cardType) {
    case 'total-animais':
      return 'üìä Total de Animais - Detalhes'
    case 'nfs-entradas':
      return 'üì• Notas Fiscais de Entrada'
    case 'nfs-saidas':
      return 'üì§ Notas Fiscais de Sa√≠da'
    case 'total-movimentacoes':
      return 'üîÑ Total de Movimenta√ß√µes'
    default:
      return 'Detalhes'
  }
}

function getCardDetailsContent(cardType, data = {}) {
    const { nfsEntradasData = [], nfsSaidasData = [], reportStats = {}, navegarParaEdicaoNF, animaisData = [] } = data
    
    switch (cardType) {
      case 'total-animais':
        const animals = animaisData

        return (
          <div className="space-y-4">
            <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
              <p className="text-sm text-blue-800 dark:text-blue-200">
                <strong>Total de {animals.length} animais</strong> cadastrados no sistema.
              </p>
            </div>
            
            <div className="space-y-3 max-h-96 overflow-y-auto">
              <h4 className="font-medium text-gray-900 dark:text-white mb-2 sticky top-0 bg-white dark:bg-gray-800 py-2">Lista de Animais:</h4>
              {animals.length > 0 ? (
                animals.map((animal) => (
                  <div 
                    key={animal.id} 
                    className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                  >
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <div className="flex items-center gap-2">
                          <span className="font-semibold text-gray-900 dark:text-white">
                            {animal.nome || 'Sem nome'}
                          </span>
                          {animal.brinco && (
                            <span className="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                              üè∑Ô∏è {animal.brinco}
                            </span>
                          )}
                        </div>
                        <div className="text-sm text-gray-600 dark:text-gray-400 mt-1 space-y-0.5">
                          <div>
                            <strong>Sexo:</strong> {animal.sexo === 'M' ? '‚ôÇÔ∏è Macho' : animal.sexo === 'F' ? '‚ôÄÔ∏è F√™mea' : animal.sexo} ‚Ä¢ 
                            <strong> Ra√ßa:</strong> {animal.raca || 'N√£o informada'}
                          </div>
                          {animal.data_nascimento && (
                            <div>
                              <strong>Nascimento:</strong> {new Date(animal.data_nascimento).toLocaleDateString('pt-BR')}
                            </div>
                          )}
                          {animal.situacao && (
                            <div>
                              <strong>Situa√ß√£o:</strong> {animal.situacao}
                            </div>
                          )}
                        </div>
                      </div>
                      <div className="flex gap-2 ml-3">
                        <button
                          onClick={async () => {
                            if (window.confirm(`Deseja editar o animal ${animal.nome || animal.brinco}?`)) {
                              window.location.href = `/animals?edit=${animal.id}`
                            }
                          }}
                          className="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors"
                          title="Editar animal"
                        >
                          <PencilIcon className="h-5 w-5" />
                        </button>
                        <button
                          onClick={async () => {
                            if (window.confirm(`Tem certeza que deseja excluir o animal ${animal.nome || animal.brinco}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                              try {
                                const response = await fetch(`/api/animals/${animal.id}`, {
                                  method: 'DELETE'
                                })
                                
                                if (response.ok) {
                                  alert('Animal exclu√≠do com sucesso!')
                                  window.location.reload()
                                } else {
                                  alert('Erro ao excluir animal. Tente novamente.')
                                }
                              } catch (error) {
                                console.error('Erro ao excluir animal:', error)
                                alert('Erro ao excluir animal. Verifique sua conex√£o.')
                              }
                            }
                          }}
                          className="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors"
                          title="Excluir animal"
                        >
                          <TrashIcon className="h-5 w-5" />
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                  Nenhum animal cadastrado
                </div>
              )}
            </div>
          </div>
        )

      case 'nfs-entradas':
        // Usar dados do banco carregados dinamicamente
        const nfsEntradas = nfsEntradasData
        
        return (
          <div className="space-y-4">
            <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
              <p className="text-sm text-green-800 dark:text-green-200">
                <strong>Defini√ß√£o:</strong> Notas fiscais de entrada registradas no per√≠odo selecionado.
              </p>
            </div>
            
            <div className="space-y-3">
              <h4 className="font-medium text-gray-900 dark:text-white">Notas Fiscais de Entrada:</h4>
              {nfsEntradas.length > 0 ? (
                nfsEntradas.map((nf, index) => (
                  <div 
                    key={index} 
                    className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
                    onClick={() => {
                      console.log('üîç NF de entrada clicada:', nf)
                      console.log('üîç Dados da NF:', {
                        numero: nf.numero_nf || nf.numero,
                        fornecedor: nf.fornecedor,
                        itens: nf.itens
                      })
                      navegarParaEdicaoNF(nf)
                    }}
                  >
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="font-medium text-gray-900 dark:text-white">
                          NF: {nf.numero_nf || nf.numero || 'N/A'}
                        </div>
                        <div className="text-sm text-gray-600 dark:text-gray-400">
                          {nf.data || nf.data_compra || 'Data n√£o informada'} ‚Ä¢ {nf.fornecedor || 'Fornecedor n√£o informado'}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="font-bold text-green-600 dark:text-green-400">
                          R$ {nf.valor_total || nf.valor ? parseFloat(nf.valor_total || nf.valor).toFixed(2) : '0,00'}
                        </div>
                        <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                          Clique para editar NF
                        </div>
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                  Nenhuma nota fiscal de entrada registrada
                </div>
              )}
            </div>
          </div>
        )

      case 'nfs-saidas':
        // Usar dados do banco carregados dinamicamente
        const nfsSaidas = nfsSaidasData
        
        return (
          <div className="space-y-4">
            <div className="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
              <p className="text-sm text-red-800 dark:text-red-200">
                <strong>Defini√ß√£o:</strong> Notas fiscais de sa√≠da registradas no per√≠odo selecionado.
              </p>
            </div>
            
            <div className="space-y-3">
              <h4 className="font-medium text-gray-900 dark:text-white">Notas Fiscais de Sa√≠da:</h4>
              {nfsSaidas.length > 0 ? (
                nfsSaidas.map((nf, index) => (
                  <div 
                    key={index} 
                    className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
                    onClick={() => {
                      console.log('üîç NF de sa√≠da clicada:', nf)
                      console.log('üîç Dados da NF:', {
                        numero: nf.numero_nf || nf.numero,
                        destino: nf.destino || nf.cliente,
                        itens: nf.itens
                      })
                      navegarParaEdicaoNF(nf)
                    }}
                  >
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="font-medium text-gray-900 dark:text-white">
                          NF: {nf.numero_nf || nf.numero || 'N/A'}
                        </div>
                        <div className="text-sm text-gray-600 dark:text-gray-400">
                          {nf.data || nf.data_compra || 'Data n√£o informada'} ‚Ä¢ {nf.destino || nf.cliente || 'Cliente n√£o informado'}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="font-bold text-red-600 dark:text-red-400">
                          R$ {nf.valor_total || nf.valor ? parseFloat(nf.valor_total || nf.valor).toFixed(2) : '0,00'}
                        </div>
                        <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                          Clique para editar NF
                        </div>
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                  Nenhuma nota fiscal de sa√≠da registrada
                </div>
              )}
            </div>
          </div>
        )

      case 'total-movimentacoes':
        // Usar dados do banco em vez do localStorage
        const totalEntradas = reportStats.nfsEntradas
        const totalSaidas = reportStats.nfsSaidas
        const totalMovimentacoes = reportStats.movimentacoes
        
        return (
          <div className="space-y-4">
            <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
              <p className="text-sm text-purple-800 dark:text-purple-200">
                <strong>Defini√ß√£o:</strong> Total de movimenta√ß√µes (entradas + sa√≠das) registradas no per√≠odo selecionado.
              </p>
            </div>
            
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-4">
                <div 
                  className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg text-center cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20 hover:border-green-300 dark:hover:border-green-600 transition-all duration-200 group"
                  onClick={() => {
                    router.push('/notas-fiscais?tipo=entrada')
                  }}
                  title="Clique para ver as notas fiscais de entrada"
                >
                  <div className="text-2xl font-bold text-green-600 dark:text-green-400 group-hover:text-green-700 dark:group-hover:text-green-300">
                    {totalEntradas}
                  </div>
                  <div className="text-sm text-gray-600 dark:text-gray-400 group-hover:text-green-600 dark:group-hover:text-green-400">
                    Entradas
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    üëÜ Clique para ver detalhes
                  </div>
                </div>
                <div 
                  className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg text-center cursor-pointer hover:bg-red-50 dark:hover:bg-red-900/20 hover:border-red-300 dark:hover:border-red-600 transition-all duration-200 group"
                  onClick={() => {
                    router.push('/notas-fiscais?tipo=saida')
                  }}
                  title="Clique para ver as notas fiscais de sa√≠da"
                >
                  <div className="text-2xl font-bold text-red-600 dark:text-red-400 group-hover:text-red-700 dark:group-hover:text-red-300">
                    {totalSaidas}
                  </div>
                  <div className="text-sm text-gray-600 dark:text-gray-400 group-hover:text-red-600 dark:group-hover:text-red-400">
                    Sa√≠das
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    üëÜ Clique para ver detalhes
                  </div>
                </div>
              </div>
              
              <div 
                className="p-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700 rounded-lg cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-800/30 hover:border-purple-300 dark:hover:border-purple-500 transition-all duration-200 group"
                onClick={() => {
                  router.push('/notas-fiscais?tipo=todas')
                }}
                title="Clique para ver todas as notas fiscais"
              >
                <div className="flex justify-between items-center">
                  <div className="font-bold text-gray-900 dark:text-white group-hover:text-purple-700 dark:group-hover:text-purple-300">
                    TOTAL DE MOVIMENTA√á√ïES
                  </div>
                  <div className="font-bold text-purple-600 dark:text-purple-400 text-lg group-hover:text-purple-700 dark:group-hover:text-purple-300">
                    {totalMovimentacoes}
                  </div>
                </div>
                <div className="text-xs text-gray-500 dark:text-gray-500 mt-2 opacity-0 group-hover:opacity-100 transition-opacity text-center">
                  üëÜ Clique para ver todas as notas fiscais
                </div>
              </div>
            </div>
          </div>
        )

      default:
        return <div>Detalhes n√£o dispon√≠veis</div>
    }
  }
